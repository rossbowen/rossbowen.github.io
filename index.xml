<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Ross Bowen</title>
<link>https://rossbowen.github.io/</link>
<atom:link href="https://rossbowen.github.io/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.6.42</generator>
<lastBuildDate>Sat, 10 May 2025 23:00:00 GMT</lastBuildDate>
<item>
  <title>Shut the box!</title>
  <link>https://rossbowen.github.io/blog/shut-the-box/</link>
  <description><![CDATA[ 




<p>A few years ago I went to Thailand with some friends. We were hanging out in a bar one night and ended up playing this game called Shut the Box.</p>
<p><img src="https://rossbowen.github.io/blog/shut-the-box/shut-the-box.jpeg" class="img-fluid"></p>
<p>The board has numbers 1 to 9. Each turn, you roll two dice. You can then flip or ‚Äúshut‚Äù any combination of numbers which sum to the total of the two dice. The game ends when you can no longer make a valid move. You win the game if no numbers are left to shut, otherwise you score the sum of the remaining open numbers.</p>
<p>We all played and started to develop our own strategies. I knew that the sum of two dice is most likely to be 7 and convinced myself that as 7 was the most likely sum and 1, 2, 3 and 4 were the least likely, I should prioritise shutting 1, 2, 3 and 4.</p>
<p>My friend‚Äôs strategy was to prioritise 7, 8 and 9 if it was possible to shut them, and if not, to prioritise the smallest numbers. He did much better and my intuition was completely wrong! But I‚Äôve always wondered if I could find the mathematically optimal strategy.</p>
<p>Thinking about this as a stochastic optimisation problem, we can model the game as a Markov decision process.</p>
<section id="markov-decision-processes" class="level2">
<h2 class="anchored" data-anchor-id="markov-decision-processes">Markov decision processes</h2>
<p>A Markov decision process models the evolution of a system over time. At each time step, an agent makes a decision that affects the future state of the system.</p>
<p>The process has a state space <img src="https://latex.codecogs.com/png.latex?S"> and evolves in discrete time steps <img src="https://latex.codecogs.com/png.latex?t%20=%201,%202%20%5Cldots"></p>
<p>At each time step, the agent chooses from a set of possible actions. Typically, the set of available actions depends on the current state <img src="https://latex.codecogs.com/png.latex?s%20%5Cin%20S">, and is denoted <img src="https://latex.codecogs.com/png.latex?A(s)">.</p>
<p>Given a state <img src="https://latex.codecogs.com/png.latex?s%20%5Cin%20S"> and an action <img src="https://latex.codecogs.com/png.latex?a%20%5Cin%20A(s)">, the system transitions to a new state <img src="https://latex.codecogs.com/png.latex?s'"> according to a transition probability <img src="https://latex.codecogs.com/png.latex?P(s'%20%5Cmid%20s,%20a)">. Each transition gives a reward <img src="https://latex.codecogs.com/png.latex?R(s,%20s',%20a)">. These transition probabilities are Markovian ‚Äì the next state depends only on the current state and action, not on the history of past states and actions.</p>
<p>The typical goal of the agent is to choose actions that maximise the expected cumulative reward over time. This means finding a <em>policy</em> <img src="https://latex.codecogs.com/png.latex?%5Cpi(s)"> ‚Äì a probabilistic mapping of states to actions ‚Äì which maximises the expected total reward.</p>
</section>
<section id="our-model" class="level2">
<h2 class="anchored" data-anchor-id="our-model">Our model</h2>
<p>For a game of Shut the Box, the state space <img src="https://latex.codecogs.com/png.latex?S"> consists of all possible subsets of the numbers 1 to 9. The state represents the set of numbers that are not shut. The game starts with all numbers open, <img src="https://latex.codecogs.com/png.latex?s%20=%20%5C%7B1,%202,%20%5Cldots,%209%5C%7D">.</p>
<p>The available actions at state <img src="https://latex.codecogs.com/png.latex?s"> depend on the total <img src="https://latex.codecogs.com/png.latex?d"> of two dice. <img src="https://latex.codecogs.com/png.latex?A_d(s)"> is the set of all subsets of <img src="https://latex.codecogs.com/png.latex?s"> whose elements sum to <img src="https://latex.codecogs.com/png.latex?d%20%5Cin%20%5C%7B%202,%203,%20%5Cldots,%2012%5C%7D">. The chosen action <img src="https://latex.codecogs.com/png.latex?a%20%5Cin%20A_d(s)"> represents the numbers to shut on that turn.</p>
<p>For example, say the remaining numbers were <img src="https://latex.codecogs.com/png.latex?s%20=%20%5C%7B1,%202,%203,%204,%205%5C%7D">, and we roll <img src="https://latex.codecogs.com/png.latex?d%20=%208">, we could shut <img src="https://latex.codecogs.com/png.latex?A_8(s)%20=%20%5C%7B%5C%7B3,%205%5C%7D">, <img src="https://latex.codecogs.com/png.latex?%5C%7B1,%202,%205%5C%7D">, or <img src="https://latex.codecogs.com/png.latex?%5C%7B1,%203,%204%5C%7D%5C%7D">.</p>
<p>The transitions between different states are deterministic based on this choice, so <img src="https://latex.codecogs.com/png.latex?s'%20=%20s%20%5Csetminus%20a">.</p>
<p>We play over the discrete time steps <img src="https://latex.codecogs.com/png.latex?t%20=%201,%202,%20%5Cldots"> and the game ends when there are no valid moves left, <img src="https://latex.codecogs.com/png.latex?A_d(s)%20=%20%5Cemptyset">. At that point a cost is incurred: <img src="https://latex.codecogs.com/png.latex?R(s)%20=%20%5Csum_%7Bi%20%5Cin%20s%7D%20i."></p>
<p>Our goal is to find a policy <img src="https://latex.codecogs.com/png.latex?%5Cpi(s,%20d)"> that minimises the expected cost.</p>
</section>
<section id="solution" class="level2">
<h2 class="anchored" data-anchor-id="solution">Solution</h2>
<p>Let <img src="https://latex.codecogs.com/png.latex?V(s)"> be the expected cost at the end of the game when proceeding from state <img src="https://latex.codecogs.com/png.latex?s">.</p>
<p>For a given dice roll <img src="https://latex.codecogs.com/png.latex?d">, define: <img src="https://latex.codecogs.com/png.latex?%0AV_d(s)%20=%0A%5Cbegin%7Bcases%7D%0A%5Cmin%5Climits_%7Ba%20%5Cin%20A_d(s)%7D%20V(s%20%5Csetminus%20a)%20&amp;%20%5Ctext%7Bif%20%7D%20A_d(s)%20%5Cne%20%5Cemptyset,%20%5C%5C%0A%5Csum%5Climits_%7Bi%20%5Cin%20s%7D%20i%20&amp;%20%5Ctext%7Botherwise%7D.%0A%5Cend%7Bcases%7D%0A"></p>
<p>Then the overall expected cost is: <img src="https://latex.codecogs.com/png.latex?V(s)%20=%20%5Csum_%7Bd=2%7D%5E%7B12%7D%20P(d)%20%5Ccdot%20V_d(s)"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?P(d)"> is the probability of rolling two dice which sum to <img src="https://latex.codecogs.com/png.latex?d">.</p>
<p>If no valid actions remain, then <img src="https://latex.codecogs.com/png.latex?V(s)"> is equivalent to the final reward: <img src="https://latex.codecogs.com/png.latex?V(s)%20=%20R(s)%20=%20%5Csum_%7Bi%20%5Cin%20s%7D%20i."></p>
<p>Using dynamic programming, we can compute the expected cost for each state <img src="https://latex.codecogs.com/png.latex?s"> by iterating over all possible states and actions.</p>
<p>First we create a function to compute the probability of rolling two dice which sum to <img src="https://latex.codecogs.com/png.latex?d">:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">ddice <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) {</span>
<span id="cb1-2">  probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span></span>
<span id="cb1-3">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(x))</span>
<span id="cb1-4">  </span>
<span id="cb1-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return 0 if the element is not in 2 to 12</span></span>
<span id="cb1-6">  is_valid <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span></span>
<span id="cb1-7">  out[is_valid] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> probs[x[is_valid] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb1-8">  </span>
<span id="cb1-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(out)</span>
<span id="cb1-10">}</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ddice</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  [1] 0.00000000 0.02777778 0.05555556 0.08333333 0.11111111 0.13888889</span></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  [7] 0.16666667 0.13888889 0.11111111 0.08333333 0.05555556 0.02777778</span></span></code></pre></div>
</div>
<p>Next we create a function to compute the set of valid actions for a given state and dice total:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(purrr)</span>
<span id="cb2-2"></span>
<span id="cb2-3">valid_actions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(s, d) {</span>
<span id="cb2-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (d <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> d <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>) {</span>
<span id="cb2-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dice total must be between 2 and 12."</span>)</span>
<span id="cb2-6">  }</span>
<span id="cb2-7">  </span>
<span id="cb2-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(s) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(s))) {</span>
<span id="cb2-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb2-10">  }</span>
<span id="cb2-11">  </span>
<span id="cb2-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The combn function doesn't handle vectors of length 1 as we intended, so</span></span>
<span id="cb2-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># we handle the special case here</span></span>
<span id="cb2-14">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(s) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb2-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> d) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(s) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb2-16">  }</span>
<span id="cb2-17">  </span>
<span id="cb2-18">  subsets <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(s), <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">combn</span>(s, x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">simplify =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">flatten</span>()</span>
<span id="cb2-20">  </span>
<span id="cb2-21">  valid_subsets <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">keep</span>(subsets, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> d)</span>
<span id="cb2-22"></span>
<span id="cb2-23">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(valid_subsets) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {</span>
<span id="cb2-24">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb2-25">  }</span>
<span id="cb2-26">  </span>
<span id="cb2-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(valid_subsets)</span>
<span id="cb2-28">}</span>
<span id="cb2-29"></span>
<span id="cb2-30"></span>
<span id="cb2-31"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">valid_actions</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb2-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [[1]]</span></span>
<span id="cb2-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 3 5</span></span>
<span id="cb2-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb2-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [[2]]</span></span>
<span id="cb2-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 1 2 5</span></span>
<span id="cb2-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; </span></span>
<span id="cb2-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [[3]]</span></span>
<span id="cb2-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 1 3 4</span></span></code></pre></div>
</div>
<p>We can implement the value function to compute the expected cost of a given state. We use memoisation to speed up the computation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(memoise)</span>
<span id="cb3-2"></span>
<span id="cb3-3">value <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(s) {</span>
<span id="cb3-4"></span>
<span id="cb3-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If the state is empty, no cost</span></span>
<span id="cb3-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(s) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(s))) {</span>
<span id="cb3-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-8">  }</span>
<span id="cb3-9"></span>
<span id="cb3-10">  dice_values <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span></span>
<span id="cb3-11">  dice_probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ddice</span>(dice_values)</span>
<span id="cb3-12"></span>
<span id="cb3-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For each dice roll, calculate the min value of next state if valid actions exist</span></span>
<span id="cb3-14">  expected_costs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map2_dbl</span>(dice_values, dice_probs, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(d, p) {</span>
<span id="cb3-15">    actions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">valid_actions</span>(s, d)</span>
<span id="cb3-16"></span>
<span id="cb3-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(actions) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(actions))) {</span>
<span id="cb3-18">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># No valid action, the game ends and we incur cost</span></span>
<span id="cb3-19">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(s))</span>
<span id="cb3-20">    }</span>
<span id="cb3-21"></span>
<span id="cb3-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Otherwise, take the best (minimal) value among next states</span></span>
<span id="cb3-23">    min_cost <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(actions, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(a) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">value</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(s, a))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>()</span>
<span id="cb3-24">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> min_cost)</span>
<span id="cb3-25">  })</span>
<span id="cb3-26"></span>
<span id="cb3-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Expected cost is weighted average over all dice outcomes</span></span>
<span id="cb3-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(expected_costs)</span>
<span id="cb3-29">}</span>
<span id="cb3-30"></span>
<span id="cb3-31">value <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">memoise</span>(value)</span>
<span id="cb3-32"></span>
<span id="cb3-33"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">value</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb3-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 6.888889</span></span>
<span id="cb3-35"></span>
<span id="cb3-36"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">value</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb3-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 5.969136</span></span></code></pre></div>
</div>
<p>And finally, for a given state and dice total, we can compute the optimal action to take:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">optimal_action <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(s, d) {</span>
<span id="cb4-2">  actions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">valid_actions</span>(s, d)</span>
<span id="cb4-3"></span>
<span id="cb4-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(actions) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(actions))) {</span>
<span id="cb4-5">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb4-6">  }</span>
<span id="cb4-7"></span>
<span id="cb4-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Evaluate each possible next state and pick the one with the lowest value</span></span>
<span id="cb4-9">  values <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(actions, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(a) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">value</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(s, a)))</span>
<span id="cb4-10">  best_index <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which.min</span>(values)</span>
<span id="cb4-11"></span>
<span id="cb4-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(actions[[best_index]])</span>
<span id="cb4-13">}</span>
<span id="cb4-14"></span>
<span id="cb4-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optimal_action</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb4-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 3 5</span></span></code></pre></div>
</div>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>With some help from Copilot we get a function to simulate a game of Shut the Box:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">simulate_game <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">state =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>) {</span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"üé≤ Starting a game of Shut the Box!</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tiles open:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(state, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"}"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-4">  </span>
<span id="cb5-5">  turn <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb5-6">  </span>
<span id="cb5-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">while</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(state) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {</span>
<span id="cb5-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Turn {turn}"</span>))</span>
<span id="cb5-9">    turn <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> turn <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb5-10"></span>
<span id="cb5-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Roll two dice</span></span>
<span id="cb5-12">    dice_values <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span></span>
<span id="cb5-13">    d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(dice_values, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ddice</span>(dice_values))</span>
<span id="cb5-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Rolled:"</span>, d, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-15">    </span>
<span id="cb5-16">    acts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">valid_actions</span>(state, d)</span>
<span id="cb5-17">    </span>
<span id="cb5-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(acts) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {</span>
<span id="cb5-19">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No valid actions! Game over.</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-20">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tiles left:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(state, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"}"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-21">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(glue<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Final score (sum of remaining tiles): {sum(state)}"</span>))</span>
<span id="cb5-22">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-23">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">invisible</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>))</span>
<span id="cb5-24">    }</span>
<span id="cb5-25">    </span>
<span id="cb5-26">    a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optimal_action</span>(state, d)</span>
<span id="cb5-27">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Action taken:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(a, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"}"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-28">    </span>
<span id="cb5-29">    state <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setdiff</span>(state, a)</span>
<span id="cb5-30">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tiles now:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(state) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"(none - you've shut the box!)"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(state, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"}"</span>)), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-31">  }</span>
<span id="cb5-32">  </span>
<span id="cb5-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"üèÜ Congratulations, you've shut the box!</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Final score: 0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb5-35">}</span>
<span id="cb5-36"></span>
<span id="cb5-37"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span>
<span id="cb5-38"></span>
<span id="cb5-39"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_game</span>()</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; üé≤ Starting a game of Shut the Box!
#&gt; Tiles open: {1, 2, 3, 4, 5, 6, 7, 8, 9} 
#&gt; 
#&gt; Turn 1
#&gt; Rolled: 8 
#&gt; Action taken: {8} 
#&gt; Tiles now: {1, 2, 3, 4, 5, 6, 7, 9} 
#&gt; 
#&gt; Turn 2
#&gt; Rolled: 10 
#&gt; Action taken: {1, 9} 
#&gt; Tiles now: {2, 3, 4, 5, 6, 7} 
#&gt; 
#&gt; Turn 3
#&gt; Rolled: 6 
#&gt; Action taken: {6} 
#&gt; Tiles now: {2, 3, 4, 5, 7} 
#&gt; 
#&gt; Turn 4
#&gt; Rolled: 11 
#&gt; Action taken: {4, 7} 
#&gt; Tiles now: {2, 3, 5} 
#&gt; 
#&gt; Turn 5
#&gt; Rolled: 3 
#&gt; Action taken: {3} 
#&gt; Tiles now: {2, 5} 
#&gt; 
#&gt; Turn 6
#&gt; Rolled: 7 
#&gt; Action taken: {2, 5} 
#&gt; Tiles now: (none - you've shut the box!) 
#&gt; 
#&gt; üèÜ Congratulations, you've shut the box!
#&gt; Final score: 0</code></pre>
</div>
</div>
<p>Great news - we won a game using our optimal policy!</p>
<p>Although we‚Äôve got a way to programatically play the game optimally from each state, it‚Äôs still hard to know what the ‚Äúrule‚Äù is without making use of some complicated look-up tables. I wanted to plot something, but the the board can have up to nine numbers open which makes it difficult to picture what‚Äôs going on in two or three dimensions.</p>
<p>To make things easier to understand, we group states by how many tiles remain open. We can then plot the expected cost for each state against the average open tile number:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warn.conflicts =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a data frame with all possible states and their expected values</span></span>
<span id="cb7-5">all_states <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">combn</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">simplify =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">flatten</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">after =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-8"></span>
<span id="cb7-9">policy_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb7-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">state =</span> all_states,</span>
<span id="cb7-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_chr</span>(all_states, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"}"</span>)),</span>
<span id="cb7-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(all_states, value),</span>
<span id="cb7-13">)</span>
<span id="cb7-14"></span>
<span id="cb7-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Let's look at a sample of the data</span></span>
<span id="cb7-16">policy_table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample_n</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb7-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 10 √ó 3</span></span>
<span id="cb7-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    state     label           value</span></span>
<span id="cb7-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;list&gt;    &lt;chr&gt;           &lt;dbl&gt;</span></span>
<span id="cb7-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1 &lt;int [5]&gt; {1, 3, 5, 7, 9} 12.3 </span></span>
<span id="cb7-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2 &lt;int [3]&gt; {4, 7, 8}       14.5 </span></span>
<span id="cb7-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3 &lt;int [5]&gt; {1, 3, 4, 7, 8} 12.0 </span></span>
<span id="cb7-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4 &lt;int [4]&gt; {3, 4, 7, 8}    15.2 </span></span>
<span id="cb7-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5 &lt;int [4]&gt; {4, 5, 6, 9}    18.0 </span></span>
<span id="cb7-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6 &lt;int [2]&gt; {1, 5}           4.61</span></span>
<span id="cb7-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7 &lt;int [5]&gt; {3, 5, 6, 8, 9} 22.7 </span></span>
<span id="cb7-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8 &lt;int [4]&gt; {1, 3, 4, 6}     5.43</span></span>
<span id="cb7-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9 &lt;int [3]&gt; {2, 6, 7}        9.86</span></span>
<span id="cb7-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10 &lt;int [3]&gt; {2, 6, 8}       12.5</span></span>
<span id="cb7-30"></span>
<span id="cb7-31">policy_table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(state)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb7-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">state_average =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(state, mean),</span>
<span id="cb7-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tiles_open =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(state, length)</span>
<span id="cb7-36">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(state_average, value, tiles_open) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(state_average, value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(tiles_open), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labeller =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label_both"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_light</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://rossbowen.github.io/blog/shut-the-box/index_files/figure-html/unnamed-chunk-6-1.svg" class="img-fluid quarto-figure quarto-figure-center figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>This definitely shows a pattern! States with higher average open tiles have higher expected costs. The costs are high, indicating some difficulty in shutting any tiles when the board is mostly made up of higher numbers. This supports the idea that we want to target higher numbers first.</p>
<p>I was curious whether this holds across all states, for all dice rolls. Do we always prioritise the action which shuts the largest number?</p>
<p>Here‚Äôs the instances where we don‚Äôt shut the largest number possible:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb8-2"></span>
<span id="cb8-3">optimal_actions <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> policy_table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand_grid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dice_total =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb8-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">actions =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map2</span>(state, dice_total, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(s, d) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">valid_actions</span>(s, d)),</span>
<span id="cb8-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">optimal_action =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map2</span>(state, dice_total, <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(s, d) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optimal_action</span>(s, d))</span>
<span id="cb8-8">  )</span>
<span id="cb8-9"></span>
<span id="cb8-10">optimal_actions <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb8-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">valid_actions_max_element =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(</span>
<span id="cb8-13">      actions,</span>
<span id="cb8-14">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(x))) <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(x))</span>
<span id="cb8-15">    ),</span>
<span id="cb8-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">valid_actions =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_chr</span>(</span>
<span id="cb8-17">        actions,</span>
<span id="cb8-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(x))) <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reduce</span>(</span>
<span id="cb8-19">            x[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], </span>
<span id="cb8-20">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(y, z) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(y, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"; {"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(z, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"}"</span>), </span>
<span id="cb8-21">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.init =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(x[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"}"</span>)</span>
<span id="cb8-22">        )</span>
<span id="cb8-23">    ),</span>
<span id="cb8-24">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">optimal_action_max_element =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(</span>
<span id="cb8-25">      optimal_action,</span>
<span id="cb8-26">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(x))) <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(x))</span>
<span id="cb8-27">    ),</span>
<span id="cb8-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">optimal_action =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_chr</span>(</span>
<span id="cb8-29">      optimal_action,</span>
<span id="cb8-30">      <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span>(x) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(x))) <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(</span>
<span id="cb8-31">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(x), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"}"</span></span>
<span id="cb8-32">      )</span>
<span id="cb8-33">    ),</span>
<span id="cb8-34">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(valid_actions_max_element <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> optimal_action_max_element) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">state =</span> label, dice_total, valid_actions, optimal_action) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-37">  DT<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datatable</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rownames =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-ffc4f25ab85bf888dc62" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-ffc4f25ab85bf888dc62">{"x":{"filter":"none","vertical":false,"data":[["{1, 2, 3, 4}","{1, 2, 4, 5}","{1, 2, 5, 6}","{1, 2, 6, 7}","{1, 3, 4, 6}","{1, 3, 5, 7}","{1, 3, 6, 8}","{1, 4, 5, 8}","{2, 3, 4, 5}","{2, 3, 5, 6}","{2, 3, 6, 7}","{2, 4, 5, 7}","{3, 4, 5, 6}","{3, 4, 6, 7}","{4, 5, 6, 7}","{1, 2, 3, 4, 5}","{1, 2, 3, 4, 6}","{1, 2, 3, 4, 6}","{1, 2, 3, 4, 7}","{1, 2, 3, 4, 8}","{1, 2, 3, 4, 9}","{1, 2, 3, 5, 6}","{1, 2, 3, 5, 6}","{1, 2, 3, 5, 6}","{1, 2, 3, 5, 7}","{1, 2, 3, 6, 7}","{1, 2, 4, 5, 6}","{1, 2, 4, 5, 7}","{1, 2, 4, 5, 7}","{1, 2, 4, 5, 7}","{1, 2, 4, 5, 8}","{1, 2, 4, 5, 8}","{1, 2, 4, 5, 9}","{1, 2, 4, 6, 7}","{1, 2, 4, 6, 7}","{1, 2, 4, 6, 7}","{1, 2, 4, 7, 8}","{1, 2, 4, 8, 9}","{1, 2, 5, 6, 8}","{1, 2, 5, 6, 8}","{1, 2, 5, 6, 9}","{1, 2, 5, 7, 8}","{1, 2, 5, 7, 9}","{1, 2, 6, 7, 9}","{1, 2, 6, 8, 9}","{1, 3, 4, 5, 6}","{1, 3, 4, 5, 6}","{1, 3, 4, 6, 8}","{1, 3, 4, 6, 9}","{1, 3, 5, 6, 7}","{1, 3, 5, 7, 8}","{1, 3, 5, 7, 9}","{1, 4, 5, 6, 7}","{1, 4, 6, 7, 9}","{2, 3, 4, 5, 6}","{2, 3, 4, 5, 6}","{2, 3, 4, 5, 8}","{2, 3, 4, 5, 9}","{2, 3, 4, 6, 7}","{2, 3, 4, 6, 7}","{2, 3, 4, 7, 8}","{2, 3, 5, 6, 7}","{2, 3, 5, 6, 9}","{2, 3, 5, 8, 9}","{2, 3, 6, 7, 8}","{2, 3, 7, 8, 9}","{2, 4, 5, 6, 7}","{2, 4, 5, 7, 8}","{2, 4, 5, 7, 8}","{2, 4, 6, 7, 8}","{2, 4, 6, 8, 9}","{2, 5, 6, 8, 9}","{3, 4, 5, 6, 7}","{3, 4, 5, 6, 7}","{3, 4, 5, 6, 8}","{3, 4, 6, 7, 8}","{3, 4, 6, 7, 9}","{3, 4, 7, 8, 9}","{3, 5, 6, 7, 8}","{3, 5, 6, 8, 9}","{4, 5, 6, 7, 8}","{4, 5, 6, 7, 9}","{1, 2, 3, 4, 5, 6}","{1, 2, 3, 4, 5, 6}","{1, 2, 3, 4, 5, 7}","{1, 2, 3, 4, 5, 7}","{1, 2, 3, 4, 5, 8}","{1, 2, 3, 4, 5, 9}","{1, 2, 3, 4, 5, 9}","{1, 2, 3, 4, 6, 7}","{1, 2, 3, 4, 6, 8}","{1, 2, 3, 4, 6, 9}","{1, 2, 3, 4, 6, 9}","{1, 2, 3, 4, 7, 8}","{1, 2, 3, 4, 7, 9}","{1, 2, 3, 4, 8, 9}","{1, 2, 3, 5, 6, 7}","{1, 2, 3, 5, 6, 7}","{1, 2, 3, 5, 6, 8}","{1, 2, 3, 5, 6, 9}","{1, 2, 3, 5, 7, 8}","{1, 2, 3, 5, 7, 9}","{1, 2, 3, 5, 8, 9}","{1, 2, 3, 5, 8, 9}","{1, 2, 3, 6, 7, 9}","{1, 2, 4, 5, 6, 7}","{1, 2, 4, 5, 6, 7}","{1, 2, 4, 5, 6, 8}","{1, 2, 4, 5, 6, 8}","{1, 2, 4, 5, 6, 9}","{1, 2, 4, 5, 7, 8}","{1, 2, 4, 5, 7, 8}","{1, 2, 4, 5, 7, 9}","{1, 2, 4, 5, 7, 9}","{1, 2, 4, 5, 8, 9}","{1, 2, 4, 6, 7, 8}","{1, 2, 4, 6, 7, 8}","{1, 2, 4, 6, 7, 9}","{1, 2, 4, 6, 7, 9}","{1, 2, 4, 6, 8, 9}","{1, 2, 4, 6, 8, 9}","{1, 2, 4, 7, 8, 9}","{1, 2, 5, 6, 7, 8}","{1, 2, 5, 6, 7, 9}","{1, 2, 5, 6, 7, 9}","{1, 2, 5, 6, 7, 9}","{1, 2, 5, 6, 8, 9}","{1, 2, 5, 7, 8, 9}","{1, 2, 5, 7, 8, 9}","{1, 3, 4, 5, 6, 7}","{1, 3, 4, 5, 6, 8}","{1, 3, 4, 5, 6, 9}","{1, 3, 4, 5, 7, 9}","{1, 3, 4, 5, 8, 9}","{1, 3, 4, 6, 7, 8}","{1, 3, 4, 6, 7, 9}","{1, 3, 4, 6, 8, 9}","{1, 3, 4, 7, 8, 9}","{1, 3, 5, 6, 7, 8}","{1, 3, 5, 6, 7, 8}","{1, 3, 5, 6, 7, 9}","{1, 3, 5, 6, 7, 9}","{1, 4, 5, 6, 7, 8}","{1, 4, 5, 6, 7, 9}","{2, 3, 4, 5, 6, 7}","{2, 3, 4, 5, 6, 9}","{2, 3, 4, 5, 6, 9}","{2, 3, 4, 5, 7, 8}","{2, 3, 4, 5, 7, 8}","{2, 3, 4, 5, 7, 8}","{2, 3, 4, 5, 8, 9}","{2, 3, 4, 6, 7, 8}","{2, 3, 4, 6, 8, 9}","{2, 3, 4, 7, 8, 9}","{2, 3, 5, 6, 7, 8}","{2, 3, 5, 6, 8, 9}","{2, 3, 6, 7, 8, 9}","{2, 4, 5, 6, 7, 8}","{2, 4, 5, 6, 8, 9}","{2, 4, 5, 7, 8, 9}","{3, 4, 5, 6, 7, 8}","{3, 4, 5, 6, 7, 9}","{3, 4, 5, 6, 8, 9}","{3, 4, 6, 7, 8, 9}","{3, 5, 6, 7, 8, 9}","{4, 5, 6, 7, 8, 9}","{1, 2, 3, 4, 5, 6, 7}","{1, 2, 3, 4, 5, 6, 9}","{1, 2, 3, 4, 5, 7, 9}","{1, 2, 3, 4, 5, 7, 9}","{1, 2, 3, 4, 5, 8, 9}","{1, 2, 3, 4, 6, 7, 9}","{1, 2, 3, 4, 6, 8, 9}","{1, 2, 3, 4, 7, 8, 9}","{1, 2, 3, 5, 6, 7, 8}","{1, 2, 3, 5, 6, 7, 8}","{1, 2, 3, 5, 6, 7, 9}","{1, 2, 3, 5, 6, 8, 9}","{1, 2, 3, 5, 6, 8, 9}","{1, 2, 3, 5, 7, 8, 9}","{1, 2, 4, 5, 6, 7, 8}","{1, 2, 4, 5, 6, 7, 8}","{1, 2, 4, 5, 6, 7, 9}","{1, 2, 4, 5, 6, 8, 9}","{1, 2, 4, 5, 7, 8, 9}","{1, 2, 4, 6, 7, 8, 9}","{1, 2, 4, 6, 7, 8, 9}","{1, 2, 5, 6, 7, 8, 9}","{1, 3, 4, 5, 6, 7, 8}","{1, 3, 4, 5, 6, 8, 9}","{1, 3, 4, 5, 6, 8, 9}","{1, 3, 4, 5, 7, 8, 9}","{1, 3, 5, 6, 7, 8, 9}","{1, 4, 5, 6, 7, 8, 9}","{2, 3, 4, 5, 6, 7, 8}","{2, 3, 4, 5, 6, 7, 8}","{2, 3, 4, 5, 6, 7, 9}","{2, 3, 4, 5, 7, 8, 9}","{2, 3, 4, 6, 7, 8, 9}","{2, 3, 4, 6, 7, 8, 9}","{3, 4, 5, 6, 7, 8, 9}","{1, 2, 3, 4, 6, 7, 8, 9}","{1, 2, 3, 5, 6, 7, 8, 9}","{1, 2, 4, 5, 6, 7, 8, 9}","{1, 3, 4, 5, 6, 7, 8, 9}"],[5,6,7,8,7,8,9,9,7,8,9,9,9,10,11,7,5,7,5,5,5,7,8,10,8,11,9,6,9,10,6,11,6,8,10,12,11,12,7,11,7,9,12,8,10,9,12,7,7,11,12,8,11,10,7,12,7,7,10,12,10,8,8,11,9,10,9,9,12,10,10,11,9,10,9,10,10,11,11,11,11,11,8,12,6,9,7,6,7,9,5,5,7,10,5,11,8,11,7,8,12,10,10,11,8,10,11,10,11,7,11,12,6,12,12,9,11,8,12,10,12,12,11,8,11,12,12,10,12,10,7,7,8,12,11,10,7,12,11,12,8,11,12,11,8,7,8,9,10,12,7,10,12,10,9,11,10,11,10,12,9,10,11,10,11,11,9,8,6,8,7,5,5,11,11,12,8,7,10,10,11,12,12,12,12,10,12,12,10,7,11,12,12,12,11,12,8,10,10,12,10,5,10,12,12],["{1, 4}; {2, 3}","{1, 5}; {2, 4}","{1, 6}; {2, 5}","{1, 7}; {2, 6}","{1, 6}; {3, 4}","{1, 7}; {3, 5}","{1, 8}; {3, 6}","{1, 8}; {4, 5}","{2, 5}; {3, 4}","{2, 6}; {3, 5}","{2, 7}; {3, 6}","{2, 7}; {4, 5}","{3, 6}; {4, 5}","{3, 7}; {4, 6}","{4, 7}; {5, 6}","{2, 5}; {3, 4}; {1, 2, 4}","{1, 4}; {2, 3}","{1, 6}; {3, 4}; {1, 2, 4}","{1, 4}; {2, 3}","{1, 4}; {2, 3}","{1, 4}; {2, 3}","{1, 6}; {2, 5}","{2, 6}; {3, 5}; {1, 2, 5}","{1, 3, 6}; {2, 3, 5}","{1, 7}; {3, 5}; {1, 2, 5}","{1, 3, 7}; {2, 3, 6}","{4, 5}; {1, 2, 6}","{1, 5}; {2, 4}","{2, 7}; {4, 5}","{1, 2, 7}; {1, 4, 5}","{1, 5}; {2, 4}","{1, 2, 8}; {2, 4, 5}","{1, 5}; {2, 4}","{1, 7}; {2, 6}","{4, 6}; {1, 2, 7}","{1, 4, 7}; {2, 4, 6}","{4, 7}; {1, 2, 8}","{4, 8}; {1, 2, 9}","{1, 6}; {2, 5}","{5, 6}; {1, 2, 8}","{1, 6}; {2, 5}","{1, 8}; {2, 7}","{5, 7}; {1, 2, 9}","{1, 7}; {2, 6}","{1, 9}; {2, 8}","{3, 6}; {4, 5}; {1, 3, 5}","{1, 5, 6}; {3, 4, 5}","{1, 6}; {3, 4}","{1, 6}; {3, 4}","{5, 6}; {1, 3, 7}","{5, 7}; {1, 3, 8}","{1, 7}; {3, 5}","{4, 7}; {5, 6}; {1, 4, 6}","{1, 9}; {4, 6}","{2, 5}; {3, 4}","{2, 4, 6}; {3, 4, 5}","{2, 5}; {3, 4}","{2, 5}; {3, 4}","{3, 7}; {4, 6}","{2, 3, 7}; {2, 4, 6}","{2, 8}; {3, 7}","{2, 6}; {3, 5}","{2, 6}; {3, 5}","{2, 9}; {3, 8}","{2, 7}; {3, 6}","{2, 8}; {3, 7}","{2, 7}; {4, 5}","{2, 7}; {4, 5}","{4, 8}; {5, 7}","{2, 8}; {4, 6}","{2, 8}; {4, 6}","{2, 9}; {5, 6}","{3, 6}; {4, 5}","{3, 7}; {4, 6}","{3, 6}; {4, 5}","{3, 7}; {4, 6}","{3, 7}; {4, 6}","{3, 8}; {4, 7}","{3, 8}; {5, 6}","{3, 8}; {5, 6}","{4, 7}; {5, 6}","{4, 7}; {5, 6}","{2, 6}; {3, 5}; {1, 2, 5}; {1, 3, 4}","{1, 5, 6}; {2, 4, 6}; {3, 4, 5}; {1, 2, 3, 6}; {1, 2, 4, 5}","{1, 5}; {2, 4}; {1, 2, 3}","{2, 7}; {4, 5}; {1, 3, 5}; {2, 3, 4}","{2, 5}; {3, 4}; {1, 2, 4}","{1, 5}; {2, 4}; {1, 2, 3}","{2, 5}; {3, 4}; {1, 2, 4}","{2, 7}; {3, 6}; {1, 2, 6}; {2, 3, 4}","{1, 4}; {2, 3}","{1, 4}; {2, 3}","{1, 6}; {3, 4}; {1, 2, 4}","{2, 8}; {3, 7}; {1, 2, 7}; {1, 2, 3, 4}","{1, 4}; {2, 3}","{2, 9}; {3, 8}; {1, 2, 8}","{1, 7}; {2, 6}; {3, 5}; {1, 2, 5}","{5, 6}; {1, 3, 7}; {2, 3, 6}; {1, 2, 3, 5}","{1, 6}; {2, 5}","{2, 6}; {3, 5}; {1, 2, 5}","{5, 7}; {1, 3, 8}; {2, 3, 7}","{1, 9}; {3, 7}; {1, 2, 7}; {2, 3, 5}","{1, 9}; {2, 8}; {2, 3, 5}","{2, 9}; {3, 8}; {1, 2, 8}; {1, 2, 3, 5}","{1, 7}; {2, 6}","{4, 6}; {1, 2, 7}; {1, 4, 5}","{4, 7}; {5, 6}; {1, 4, 6}; {2, 4, 5}","{2, 8}; {4, 6}; {1, 4, 5}","{5, 6}; {1, 2, 8}; {1, 4, 6}; {2, 4, 5}","{1, 6}; {2, 5}; {1, 2, 4}","{4, 7}; {1, 2, 8}; {2, 4, 5}","{4, 8}; {5, 7}; {1, 4, 7}; {1, 2, 4, 5}","{1, 5}; {2, 4}","{5, 7}; {1, 2, 9}; {1, 4, 7}; {1, 2, 4, 5}","{4, 8}; {1, 2, 9}; {1, 2, 4, 5}","{1, 8}; {2, 7}; {1, 2, 6}","{4, 7}; {1, 2, 8}; {1, 4, 6}","{1, 7}; {2, 6}","{1, 2, 9}; {1, 4, 7}; {2, 4, 6}","{1, 9}; {2, 8}; {4, 6}","{4, 8}; {1, 2, 9}; {2, 4, 6}","{4, 8}; {1, 2, 9}; {1, 4, 7}","{5, 6}; {1, 2, 8}","{1, 7}; {2, 6}; {1, 2, 5}","{2, 9}; {5, 6}","{5, 7}; {1, 2, 9}; {1, 5, 6}","{1, 2, 9}; {1, 5, 6}","{1, 9}; {2, 8}; {1, 2, 7}","{5, 7}; {1, 2, 9}","{3, 7}; {4, 6}; {1, 3, 6}; {1, 4, 5}","{1, 6}; {3, 4}","{1, 6}; {3, 4}","{1, 7}; {3, 5}; {1, 3, 4}","{3, 9}; {4, 8}; {1, 3, 8}; {3, 4, 5}","{3, 8}; {4, 7}; {1, 3, 7}; {1, 4, 6}","{1, 9}; {3, 7}; {4, 6}; {1, 3, 6}","{1, 6}; {3, 4}","{3, 9}; {4, 8}; {1, 3, 8}; {1, 4, 7}","{3, 8}; {5, 6}; {1, 3, 7}","{5, 7}; {1, 3, 8}; {1, 5, 6}","{1, 7}; {3, 5}","{5, 6}; {1, 3, 7}","{4, 8}; {5, 7}; {1, 4, 7}; {1, 5, 6}","{4, 7}; {5, 6}; {1, 4, 6}","{2, 6}; {3, 5}","{2, 5}; {3, 4}","{2, 6}; {3, 5}","{2, 7}; {4, 5}; {2, 3, 4}","{2, 8}; {3, 7}; {2, 3, 5}","{4, 8}; {5, 7}; {2, 3, 7}; {3, 4, 5}","{2, 5}; {3, 4}","{2, 8}; {3, 7}; {4, 6}","{3, 9}; {4, 8}; {2, 4, 6}","{2, 8}; {3, 7}","{2, 7}; {3, 6}","{2, 9}; {3, 8}; {5, 6}; {2, 3, 6}","{2, 8}; {3, 7}","{4, 7}; {5, 6}; {2, 4, 5}","{2, 8}; {4, 6}","{4, 8}; {5, 7}","{3, 6}; {4, 5}","{3, 7}; {4, 6}","{3, 8}; {5, 6}","{3, 7}; {4, 6}","{3, 8}; {5, 6}","{4, 7}; {5, 6}","{2, 7}; {3, 6}; {4, 5}; {1, 2, 6}; {1, 3, 5}; {2, 3, 4}","{2, 6}; {3, 5}; {1, 2, 5}; {1, 3, 4}","{1, 5}; {2, 4}; {1, 2, 3}","{1, 7}; {3, 5}; {1, 2, 5}; {1, 3, 4}","{2, 5}; {3, 4}; {1, 2, 4}","{1, 4}; {2, 3}","{1, 4}; {2, 3}","{2, 9}; {3, 8}; {4, 7}; {1, 2, 8}; {1, 3, 7}","{3, 8}; {5, 6}; {1, 2, 8}; {1, 3, 7}; {2, 3, 6}; {1, 2, 3, 5}","{5, 7}; {1, 3, 8}; {1, 5, 6}; {2, 3, 7}; {1, 2, 3, 6}","{1, 7}; {2, 6}; {3, 5}; {1, 2, 5}","{1, 6}; {2, 5}","{1, 9}; {2, 8}; {1, 3, 6}; {2, 3, 5}","{1, 9}; {2, 8}; {3, 7}; {1, 2, 7}; {2, 3, 5}","{4, 7}; {5, 6}; {1, 2, 8}; {1, 4, 6}; {2, 4, 5}","{4, 8}; {5, 7}; {1, 4, 7}; {1, 5, 6}; {2, 4, 6}; {1, 2, 4, 5}","{5, 7}; {1, 2, 9}; {1, 4, 7}; {1, 5, 6}; {2, 4, 6}; {1, 2, 4, 5}","{4, 8}; {1, 2, 9}; {1, 5, 6}; {2, 4, 6}; {1, 2, 4, 5}","{4, 8}; {5, 7}; {1, 2, 9}; {1, 4, 7}; {1, 2, 4, 5}","{1, 9}; {2, 8}; {4, 6}; {1, 2, 7}","{4, 8}; {1, 2, 9}; {1, 4, 7}; {2, 4, 6}","{5, 7}; {1, 2, 9}; {1, 5, 6}","{3, 7}; {4, 6}; {1, 3, 6}; {1, 4, 5}","{1, 6}; {3, 4}","{3, 8}; {5, 6}; {1, 4, 6}","{3, 9}; {4, 8}; {5, 7}; {1, 3, 8}; {1, 4, 7}; {3, 4, 5}","{3, 9}; {5, 7}; {1, 3, 8}; {1, 5, 6}","{4, 8}; {5, 7}; {1, 4, 7}; {1, 5, 6}","{3, 8}; {4, 7}; {5, 6}; {2, 3, 6}; {2, 4, 5}","{4, 8}; {5, 7}; {2, 3, 7}; {2, 4, 6}; {3, 4, 5}","{2, 6}; {3, 5}","{2, 8}; {3, 7}; {2, 3, 5}","{2, 8}; {3, 7}; {4, 6}","{3, 9}; {4, 8}; {2, 3, 7}; {2, 4, 6}","{3, 7}; {4, 6}","{1, 4}; {2, 3}","{1, 9}; {2, 8}; {3, 7}; {1, 2, 7}; {1, 3, 6}; {2, 3, 5}","{4, 8}; {5, 7}; {1, 2, 9}; {1, 4, 7}; {1, 5, 6}; {2, 4, 6}; {1, 2, 4, 5}","{3, 9}; {4, 8}; {5, 7}; {1, 3, 8}; {1, 4, 7}; {1, 5, 6}; {3, 4, 5}"],["{2, 3}","{2, 4}","{2, 5}","{2, 6}","{3, 4}","{3, 5}","{3, 6}","{4, 5}","{3, 4}","{3, 5}","{3, 6}","{4, 5}","{4, 5}","{4, 6}","{5, 6}","{3, 4}","{2, 3}","{3, 4}","{2, 3}","{2, 3}","{2, 3}","{2, 5}","{3, 5}","{2, 3, 5}","{3, 5}","{2, 3, 6}","{4, 5}","{2, 4}","{4, 5}","{1, 4, 5}","{2, 4}","{2, 4, 5}","{2, 4}","{2, 6}","{4, 6}","{2, 4, 6}","{4, 7}","{4, 8}","{2, 5}","{5, 6}","{2, 5}","{2, 7}","{5, 7}","{2, 6}","{2, 8}","{4, 5}","{3, 4, 5}","{3, 4}","{3, 4}","{5, 6}","{5, 7}","{3, 5}","{5, 6}","{4, 6}","{3, 4}","{3, 4, 5}","{3, 4}","{3, 4}","{4, 6}","{2, 4, 6}","{3, 7}","{3, 5}","{3, 5}","{3, 8}","{3, 6}","{3, 7}","{4, 5}","{4, 5}","{5, 7}","{4, 6}","{4, 6}","{5, 6}","{4, 5}","{4, 6}","{4, 5}","{4, 6}","{4, 6}","{4, 7}","{5, 6}","{5, 6}","{5, 6}","{5, 6}","{3, 5}","{3, 4, 5}","{2, 4}","{4, 5}","{3, 4}","{2, 4}","{3, 4}","{3, 6}","{2, 3}","{2, 3}","{3, 4}","{3, 7}","{2, 3}","{3, 8}","{2, 6}","{5, 6}","{2, 5}","{3, 5}","{5, 7}","{3, 7}","{2, 8}","{3, 8}","{2, 6}","{4, 6}","{5, 6}","{4, 6}","{5, 6}","{2, 5}","{4, 7}","{5, 7}","{2, 4}","{5, 7}","{4, 8}","{2, 7}","{4, 7}","{2, 6}","{2, 4, 6}","{2, 8}","{4, 8}","{4, 8}","{5, 6}","{2, 6}","{5, 6}","{5, 7}","{1, 5, 6}","{2, 8}","{5, 7}","{4, 6}","{3, 4}","{3, 4}","{3, 5}","{4, 8}","{4, 7}","{4, 6}","{3, 4}","{4, 8}","{5, 6}","{5, 7}","{3, 5}","{5, 6}","{5, 7}","{5, 6}","{3, 5}","{3, 4}","{3, 5}","{4, 5}","{3, 7}","{5, 7}","{3, 4}","{4, 6}","{4, 8}","{3, 7}","{3, 6}","{3, 8}","{3, 7}","{5, 6}","{4, 6}","{5, 7}","{4, 5}","{4, 6}","{5, 6}","{4, 6}","{5, 6}","{5, 6}","{3, 6}","{3, 5}","{2, 4}","{3, 5}","{3, 4}","{2, 3}","{2, 3}","{3, 8}","{5, 6}","{5, 7}","{2, 6}","{2, 5}","{2, 8}","{2, 8}","{5, 6}","{5, 7}","{5, 7}","{4, 8}","{4, 8}","{2, 8}","{4, 8}","{5, 7}","{4, 6}","{3, 4}","{5, 6}","{4, 8}","{5, 7}","{5, 7}","{5, 6}","{5, 7}","{3, 5}","{3, 7}","{4, 6}","{4, 8}","{4, 6}","{2, 3}","{2, 8}","{5, 7}","{4, 8}"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>state<\/th>\n      <th>dice_total<\/th>\n      <th>valid_actions<\/th>\n      <th>optimal_action<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":1},{"name":"state","targets":0},{"name":"dice_total","targets":1},{"name":"valid_actions","targets":2},{"name":"optimal_action","targets":3}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<style>
  .datatables {
    margin-bottom: 1rem;
  }
</style>
<p>I found myself staring at this for a while, particularly at the results for state <img src="https://latex.codecogs.com/png.latex?%5C%7B1,%204,%205,%208%5C%7D"> given a dice roll of 9. In this scenario we can choose to close <img src="https://latex.codecogs.com/png.latex?%5C%7B1,%208%5C%7D"> or <img src="https://latex.codecogs.com/png.latex?%5C%7B4,%205%5C%7D">. Our computations suggest closing <img src="https://latex.codecogs.com/png.latex?%5C%7B4,%205%5C%7D">.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">value</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>))</span>
<span id="cb9-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 6.888889</span></span>
<span id="cb9-3"></span>
<span id="cb9-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">value</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb9-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; [1] 7.027778</span></span></code></pre></div>
</div>
<p>At first, this result felt counterintuitive ‚Äî I had expected that winning (shutting all tiles) from the state <img src="https://latex.codecogs.com/png.latex?%5C%7B4,%205%5C%7D"> would be more likely than from <img src="https://latex.codecogs.com/png.latex?%5C%7B1,%208%5C%7D">, and so this would give <img src="https://latex.codecogs.com/png.latex?%5C%7B4,%205%5C%7D"> a lower expected cost.</p>
<p>From the state <img src="https://latex.codecogs.com/png.latex?%5C%7B4,%205%5C%7D">, we can only proceed if we roll a 4, 5, or 9. Any other dice roll results in an immediate loss:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0AP(%5Ctext%7BWin%20from%20%7D%20%5C%7B4,%205%5C%7D)%20&amp;=%20P(%5Ctext%7BRoll%204%20and%20win%20from%20%7D%20%5C%7B5%5C%7D)%20%5C%5C%0A&amp;+%20P(%5Ctext%7BRoll%205%20and%20win%20from%20%7D%20%5C%7B4%5C%7D)%20%5C%5C%0A&amp;+%20P(%5Ctext%7BRoll%209%7D)%0A%5Cend%7Balign%7D%0A"></p>
<p>We observe that:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP(%5Ctext%7BWin%20from%20%7D%20%5C%7B4%5C%7D)%20=%20P(%5Ctext%7BRoll%20%7D%204)%20=%20%5Cfrac%7B3%7D%7B36%7D,%0A"></p>
<p>and</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP(%5Ctext%7BWin%20from%20%7D%20%5C%7B5%5C%7D)%20=%20P(%5Ctext%7BRoll%20%7D%205)%20=%20%5Cfrac%7B4%7D%7B36%7D.%0A"></p>
<p>Combining these, we compute:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AP(%5Ctext%7BWin%20from%20%7D%20%5C%7B4,%205%5C%7D)%20=%20%5Cfrac%7B3%7D%7B36%7D%20%5Ccdot%20%5Cfrac%7B3%7D%7B36%7D%20+%20%5Cfrac%7B4%7D%7B36%7D%20%5Ccdot%20%5Cfrac%7B4%7D%7B36%7D%20+%20%5Cfrac%7B4%7D%7B36%7D%20%5Capprox%200.13.%0A"></p>
<p>The probability of winning from <img src="https://latex.codecogs.com/png.latex?%5C%7B1,%208%5C%7D"> is the same as rolling a 9 (as that‚Äôs the only winning action), which is <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B4%7D%7B36%7D%20%5Capprox%200.11">. So it‚Äôs true ‚Äì we‚Äôre slightly more likely to win the game from the state <img src="https://latex.codecogs.com/png.latex?%5C%7B4,%205%5C%7D">. But our value function isn‚Äôt set up to maximise our probability of winning, it‚Äôs set up to minimise our expected cost.</p>
<p>The possibility of scoring 1 from state <img src="https://latex.codecogs.com/png.latex?%5C%7B1,%208%5C%7D"> by rolling an 8 pulls the expected cost down, making it the better state to land on. The objectives of maximising winning chances and minimising expected costs diverge slightly!</p>
<p>So we‚Äôve not managed to come up with a ‚Äúrule‚Äù for people to follow, but it seems like we can do pretty well by closing fewer tiles, and prioritising closing higher numbers.</p>
<p>Finally, to wrap up, what is the state with the highest expected cost?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">policy_table <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">desc</span>(value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(label, value) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>()</span>
<span id="cb10-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 6 √ó 2</span></span>
<span id="cb10-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   label              value</span></span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;              &lt;dbl&gt;</span></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 {5, 6, 7, 8, 9}     24.7</span></span>
<span id="cb10-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2 {4, 5, 7, 8, 9}     23.8</span></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 3 {6, 7, 8, 9}        23.6</span></span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 4 {4, 5, 6, 7, 8, 9}  23.2</span></span>
<span id="cb10-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 5 {5, 7, 8, 9}        22.7</span></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 6 {4, 6, 7, 8, 9}     22.7</span></span></code></pre></div>
</div>
<p>Turns out my original plan wasn‚Äôt just inoptimal, but the game state where 1, 2, 3 and 4 have all been shut has the highest expected cost. It‚Äôs the worst possible strategy!</p>


</section>

 ]]></description>
  <guid>https://rossbowen.github.io/blog/shut-the-box/</guid>
  <pubDate>Sat, 10 May 2025 23:00:00 GMT</pubDate>
</item>
<item>
  <title>QUALIFY in SQL</title>
  <link>https://rossbowen.github.io/blog/qualify-in-sql/</link>
  <description><![CDATA[ 




<p>Last year, while starting to use Snowflake, I discovered the <code>QUALIFY</code> keyword in SQL.</p>
<p><code>QUALIFY</code> filters results based on a window function. It‚Äôs not part of the SQL standard and so won‚Äôt be supported in all SQL engines, but I think it has good coverage in some of the newer ones.</p>
<p>Let‚Äôs say we have an <code>employees</code> table, courtesy of ChatGPT:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb1-1">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span id="cb1-2">‚îÇ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">id</span> ‚îÜ name    ‚îÜ department  ‚îÜ salary ‚îÇ</span>
<span id="cb1-3">‚ïû‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï°</span>
<span id="cb1-4">‚îÇ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> ‚îÜ Alice   ‚îÜ Engineering ‚îÜ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70000</span> ‚îÇ</span>
<span id="cb1-5">‚îÇ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> ‚îÜ Bob     ‚îÜ Engineering ‚îÜ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72000</span> ‚îÇ</span>
<span id="cb1-6">‚îÇ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> ‚îÜ Charlie ‚îÜ HR          ‚îÜ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65000</span> ‚îÇ</span>
<span id="cb1-7">‚îÇ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> ‚îÜ Diana   ‚îÜ HR          ‚îÜ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">68000</span> ‚îÇ</span>
<span id="cb1-8">‚îÇ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> ‚îÜ Eve     ‚îÜ Engineering ‚îÜ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">71000</span> ‚îÇ</span>
<span id="cb1-9">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span></code></pre></div>
<p>We want to find the top earner for each department. With <code>QUALIFY</code>, the query becomes concise:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SELECT</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> </span>
<span id="cb2-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> employees</span>
<span id="cb2-3">QUALIFY <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RANK</span>() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">OVER</span> (<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PARTITION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">BY</span> department <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">BY</span> salary <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DESC</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>;</span></code></pre></div>
<p>Here, <code>RANK()</code> ranks employees within each department by salary, and <code>QUALIFY</code> filters the results to show only the top earner in each department.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb3-1">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span>
<span id="cb3-2">‚îÇ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">id</span> ‚îÜ name  ‚îÜ department  ‚îÜ salary ‚îÇ</span>
<span id="cb3-3">‚ïû‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï°</span>
<span id="cb3-4">‚îÇ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> ‚îÜ Bob   ‚îÜ Engineering ‚îÜ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72000</span> ‚îÇ</span>
<span id="cb3-5">‚îÇ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> ‚îÜ Diana ‚îÜ HR          ‚îÜ  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">68000</span> ‚îÇ</span>
<span id="cb3-6">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span></code></pre></div>
<p>Previously when doing something like this, I would use a common table expression (CTE):</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WITH</span> ranked_employees <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> (</span>
<span id="cb4-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SELECT</span> </span>
<span id="cb4-3">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>,</span>
<span id="cb4-4">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RANK</span>() <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">OVER</span> (<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">PARTITION</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">BY</span> department <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">ORDER</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">BY</span> salary <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">DESC</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">AS</span> employee_rank</span>
<span id="cb4-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> employees</span>
<span id="cb4-6">)</span>
<span id="cb4-7"></span>
<span id="cb4-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">SELECT</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb4-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">FROM</span> ranked_employees</span>
<span id="cb4-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">WHERE</span> employee_rank <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>;</span></code></pre></div>
<p>As a small query, I still think using a CTE is fine, but when using multiple CTEs in a larger or more complex query, the brevity of <code>QUALIFY</code> is really nice.</p>
<p>Want to try it out? Check out the <a href="https://shell.duckdb.org/#queries=v0,CREATE-TABLE-employees-AS%0ASELECT-*-FROM-(VALUES%0A----(1%2C-'Alice'%2C-'Engineering'%2C-70000)%2C%0A----(2%2C-'Bob'%2C-'Engineering'%2C-72000)%2C%0A----(3%2C-'Charlie'%2C-'HR'%2C-65000)%2C%0A----(4%2C-'Diana'%2C-'HR'%2C-68000)%2C%0A----(5%2C-'Eve'%2C-'Engineering'%2C-71000)%0A)-AS-t(id%2C-name%2C-department%2C-salary)~%0A,SELECT-*-FROM-employees~,SELECT-*-FROM-employees-QUALIFY-RANK()-OVER-(PARTITION-BY-department-ORDER-BY-salary-DESC)-%3D-1~">DuckDB web shell</a>.</p>



 ]]></description>
  <guid>https://rossbowen.github.io/blog/qualify-in-sql/</guid>
  <pubDate>Mon, 21 Apr 2025 23:00:00 GMT</pubDate>
</item>
<item>
  <title>My ideal open data API</title>
  <link>https://rossbowen.github.io/blog/my-ideal-data-api/</link>
  <description><![CDATA[ 




<p>Most data across government are published in presentational spreadsheets. These spreadsheets are great for being read by humans (<a href="https://analysisfunction.civilservice.gov.uk/policy-store/releasing-statistics-in-spreadsheets/">though there‚Äôs always ways to make them more accessible</a>), but they‚Äôre often not ideal for reusing the data programmatically in tools like R or Python.</p>
<p>It‚Äôs been <a href="https://timharford.com/2013/06/a-statistical-needle-in-a-bureaucratic-haystack/">noted for a while that having data in a ‚Äúgazillion spreadsheets‚Äù isn‚Äôt so helpful</a>, and new services like the <a href="https://ukhsa-dashboard.data.gov.uk/">UKSHA dashboard</a>, <a href="https://explore-local-statistics.beta.ons.gov.uk/">Explore local statistics</a> and <a href="https://www.planning.data.gov.uk/">planning.data.gov.uk</a> have popped up to provide a better way. These new services <a href="https://www.spectator.co.uk/article/pouria-hadjibagheri-and-the-uks-abandoned-open-data-revolution/">haven‚Äôt gone unnoticed</a>, and there is demand for services which are built in the open and make data available through simple to understand APIs.</p>
<p>The <a href="https://integrateddataservice.gov.uk/">Integrated Data Service</a> aims to bring <em>ready-to-use data to enable faster and wider collaborative analysis for the public good</em>, but looks primarily focussed on making microdata available in a highly secure trusted research environment. <a href="https://www.gov.uk/government/publications/independent-review-of-the-uk-statistics-authority-uksa-2023/independent-review-of-the-uk-statistics-authority-by-professor-denise-lievesley-cbe-html#integrated-data-service-ids">Some researchers feel uncertain about the purpose of the service</a>. I feel that there‚Äôs huge value to be unlocked in also giving attention to data which are routinely published in difficult to reuse spreadsheets and making that data available, in ready-to-use formats, openly.</p>
<p><a href="https://lindas.admin.ch/">Switzerland has made cool progress</a> to providing their statistical data as a knowledge graph, and I previously worked on a project looking to achieve a similar thing. I learned a lot in that time and wanted to share the blueprint for what I think would make a pretty good data API for datasets (before I forget it all!)</p>
<section id="goals" class="level2">
<h2 class="anchored" data-anchor-id="goals">Goals</h2>
<p>I wouldn‚Äôt apply my thinking to every API out there. But I‚Äôm thinking specifically about how an analytical customer might get a better experience when trying to work with data.</p>
<p>I‚Äôve met analysts who aren‚Äôt all that familiar with APIs or familiar with JSON, and may not have the tools or experience to properly interact with an API. I was one of them!</p>
<p>When I was getting started I knew that APIs were a way for me to get data for me to analyse by using some URLs. Chaining together multiple API calls, using strange looking URLs, scouring through documentation and being uncertain about whether my code was the problem or whether I‚Äôd made a mistake in forming the URL was all a part of the initially painful experience. I was used to working with tabular data, so navigating highly nested JSON in my tools of choice felt disorienting.</p>
<p>I didn‚Äôt know about <a href="https://twitter.com/housecor/status/1727687082372386904">REST or HATEOAS</a>, or even really care ‚Äì I just wanted some data!</p>
<p>With that in mind, I felt that the goal of an open data API is a design which compliments how an analyst finds and explores data.</p>
<hr>
<p>When I find a dataset on a website like data.gov.uk or ons.gov.uk, I likely arrived there through a Google search. The process of moving from that webpage to importing the data into my statistical software should be straightforward. I want to quickly load the data into my tool to assess whether it‚Äôs suitable for my needs.</p>
<p>Imagine the specific webpage was <code>https://data.gov.uk/datasets/gross-domestic-product</code>. I‚Äôm looking at a nicely formatted webpage in my browser which describes the dataset with metadata about when it was released and who published it etc.</p>
<p>To load it into R, I want to be able to do:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(readr)</span>
<span id="cb1-2"></span>
<span id="cb1-3">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/datasets/gross-domestic-product"</span>)</span></code></pre></div>
<p>With one line, the latest data is available for me to explore, and the URL is <em>exactly the same</em> as the URL used in my browser. I‚Äôm really inspired by <a href="https://ruben.verborgh.org/blog/2013/11/29/the-lie-of-the-api/">this blog post by Ruben Verborgh</a> where the case is made for using content negotiation, which enables this magic.</p>
<hr>
<p>In open data circles, the <a href="https://www.go-fair.org/fair-principles/">FAIR principles</a> are frequently discussed. FAIR stands for Findable, Accessible, Interoperable, and Reusable.</p>
<p>The <a href="https://w3c.github.io/dwbp/bp.html">Data on the Web Best Practices</a> offer recommendations similar to the FAIR principles, and I‚Äôm a big fan of this document. These recommendations were developed based on <a href="https://www.w3.org/TR/dwbp-ucr/">use cases and requirements</a> collected from open data users.</p>
<p>To summarise broadly, the advice boils down to:</p>
<ul>
<li>Choose a globally unique and persistent identifier for a dataset.</li>
<li>Provide metadata, including information about structure, provenance, licences, etc.</li>
<li>Do dataset versioning well.</li>
<li>Be a good web citizen by leveraging HTTP and offering multiple formats.</li>
</ul>
<p>Additionally, I recommend ensuring that if you provide data in a tabular format (like CSV), it should be formatted as <a href="https://r4ds.had.co.nz/tidy-data.html">tidy data</a>.</p>
<p>I‚Äôll explain each of these points in more detail.</p>
</section>
<section id="choose-a-globally-unique-and-persistent-identifier" class="level2">
<h2 class="anchored" data-anchor-id="choose-a-globally-unique-and-persistent-identifier">Choose a globally unique and persistent identifier</h2>
<p>It‚Äôs recommended to use a globally unique and persistent identifier for a dataset to ensure that it can always be reliably found and referenced over time. By giving a unique ID to each dataset, we avoid confusion and duplication, making it easier for researchers and systems to locate and access the exact dataset we‚Äôre referring to.</p>
<p>A persistent identifier means the link to the dataset will not break or change, even if the dataset moves to a different location or is updated. <a href="https://www.w3.org/Provider/Style/URI">Cool URIs don‚Äôt change</a>.</p>
<p>We carefully considered what the URL scheme should look like and ended up with something roughly like this:</p>
<ul>
<li><code>https://data.gov.uk</code></li>
<li><code>https://data.gov.uk/datasets</code></li>
<li><code>https://data.gov.uk/themes/economy</code></li>
<li><code>https://data.gov.uk/datasets/gross-domestic-product</code></li>
<li><code>https://data.gov.uk/datasets/gross-domestic-product/editions/2024-05</code></li>
<li><code>https://data.gov.uk/datasets/gross-domestic-product/editions/2024-05.csv</code></li>
<li><code>https://data.gov.uk/datasets/gross-domestic-product/editions/2024-05.json</code></li>
<li><code>https://data.gov.uk/datasets/gross-domestic-product/editions/2024-05/versions/1</code></li>
</ul>
<p>The main features of these URLs are:</p>
<ul>
<li>We pay attention to the URL structure and naming conventions, as they are permanent.</li>
<li>The URLs use <code>kebab-case</code>, which is beneficial for search engine optimisation.</li>
<li>The URLs are designed to be fairly human-readable.</li>
<li>URLs for related resources build upon one another in a hierarchical structure.</li>
<li>We use ISO standards for years, quarters, months, etc.</li>
<li>The URLs for datasets don‚Äôt contain the theme or other descriptive metadata, as this may change or a dataset may have multiple themes.</li>
<li>We follow the principle that <a href="https://www.w3.org/Provider/Style/URI">Cool URIs don‚Äôt change</a>.</li>
</ul>
<hr>
<p>Many data APIs require us to use a different URL to <em>access</em> a dataset from the URL of the webpage that <em>describes</em> the dataset. So which one of these URLs truly uniquely represents the dataset? Which one should show up in Google searches, or be used in academic papers?</p>
<p>One of the big debating points was whether it‚Äôs significantly more effort for users to request data from:</p>
<ul>
<li><code>https://api.data.gov.uk/v2/datasets/gross-domestic-product/edition/2024-05/csv</code></li>
</ul>
<p>instead of:</p>
<ul>
<li><code>https://data.gov.uk/datasets/gross-domestic-product.csv</code></li>
<li><code>https://data.gov.uk/datasets/gross-domestic-product/edition/2024-05.csv</code></li>
</ul>
<p>and I‚Äôd argue that yes, it is:</p>
<ul>
<li>Sharing the first URL with a colleague loses the direct connection to the user-friendly webpage that describes the dataset. There is no obvious relationship between this API URL and the URL that users would see on a search engine, which makes it harder to find and understand the dataset.</li>
<li>Using an <code>api</code> subdomain, including an API version like <code>/v2/</code>, and requiring users to specify a dataset edition complicates the process of quickly assessing if the data is suitable ‚Äì users end up mutating URLs by hand.</li>
<li>Additionally, including an API version such as <code>/v2/</code> implies that the dataset‚Äôs identifier might change with future API versions, which means the URL might not remain persistent.</li>
</ul>
<p>My aim was to try and work a bit harder behind the scenes, so we didn‚Äôt have to pass the complexity of manipulating URLs to the user.</p>
</section>
<section id="use-tidy-data" class="level2">
<h2 class="anchored" data-anchor-id="use-tidy-data">Use tidy data</h2>
<p>Providing data in a presentational format, such as a spreadsheet, can be helpful to read the data but difficult to reuse the data. Data needs to be available as <a href="https://r4ds.had.co.nz/tidy-data.html">tidy data</a> in another format such as CSV in order to be reusable. <a href="https://www.robinlinacre.com/parquet_api/">Robin Linacre argues for parquet</a> (and makes a lot of other great points I agree with!)</p>
<p>Consider this example taken from the <a href="https://www.w3.org/TR/vocab-data-cube/">RDF data cube vocabulary</a>, which describes life expectancy broken down by region, sex and time:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># An example of how the table looks once imported into R:</span></span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># A tibble: 6 x 7</span></span>
<span id="cb2-4">  V1                V2        V3        V4        V5     V6    V7  </span>
<span id="cb2-5">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>chr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>             <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;</span>chr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>     <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;</span>chr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>     <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;</span>chr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>     <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;</span>chr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>  <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;</span>chr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;</span>chr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> </span>
<span id="cb2-6"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>                <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2004-2006</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2005-2007</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2006-2008</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>     <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>    <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>  </span>
<span id="cb2-7"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>                Male      Female    Male      Female Male  Female</span>
<span id="cb2-8"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Newport"</span>         <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">76.7</span>      <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">80.7</span>      <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">77.1</span>      <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">80.9</span>   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">77.0</span>  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">81.5</span>  </span>
<span id="cb2-9"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Cardiff"</span>         <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">78.7</span>      <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">83.3</span>      <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">78.6</span>      <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">83.7</span>   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">78.7</span>  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">83.4</span>  </span>
<span id="cb2-10"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Monmouthshire"</span>   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">76.6</span>      <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">81.3</span>      <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">76.5</span>      <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">81.5</span>   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">76.6</span>  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">81.7</span>  </span>
<span id="cb2-11"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Merthyr Tydfil"</span>  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">75.5</span>      <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">79.1</span>      <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">75.5</span>      <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">79.4</span>   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">74.9</span>  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">79.6</span>  </span></code></pre></div>
<p>The table is a cross tabulation of the data, with the columns representing the time period of the observation and the sex of the observed population and the rows representing different locations. Having multiple header rows which span multiple columns makes the data difficult to read with software. Downstream users of the data will have to wrangle the data into a usable format.</p>
<p>Importing the above table into a statistical software such as R produces a result with some problems:</p>
<ul>
<li>The header rows are not treated as headers</li>
<li>The header row representing time period is not fully populated</li>
<li>The first column contains empty strings</li>
<li>Numbers in the data are treated as strings, due to columns having mixed data types</li>
</ul>
<p>Organising the table as tidy data, with each variable having its own column gives an output which can be instantly read into R, without need for further cleaning.</p>
<p>For data to be classified as tidy data:</p>
<ol type="1">
<li>Each variable forms a column</li>
<li>Each observation forms a row</li>
<li>Each type of observational unit forms a table</li>
</ol>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># A tibble: 24 √ó 4</span></span>
<span id="cb3-2">   area    sex    period    life_expectancy</span>
<span id="cb3-3">   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span>chr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>   <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;</span>chr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>  <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;</span>chr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span>               <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;</span>dbl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb3-4"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> Newport Male   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2004-2006</span>            <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">76.7</span></span>
<span id="cb3-5"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> Newport Female <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2004-2006</span>            <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">80.7</span></span>
<span id="cb3-6"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> Newport Male   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2005-2007</span>            <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">77.1</span></span>
<span id="cb3-7"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> Newport Female <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2005-2007</span>            <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">80.9</span></span>
<span id="cb3-8"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> Newport Male   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2006-2008</span>            <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">77.0</span></span>
<span id="cb3-9"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span> Newport Female <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2006-2008</span>            <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">81.5</span></span>
<span id="cb3-10"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span> Cardiff Male   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2004-2006</span>            <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">78.7</span></span>
<span id="cb3-11"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span> Cardiff Female <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2004-2006</span>            <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">83.3</span></span>
<span id="cb3-12"> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span> Cardiff Male   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2005-2007</span>            <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">78.6</span></span>
<span id="cb3-13"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> Cardiff Female <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2005-2007</span>            <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">83.7</span></span>
<span id="cb3-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ‚Ñπ 14 more rows</span></span>
<span id="cb3-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ‚Ñπ Use `print(n = ...)` to see more rows</span></span></code></pre></div>
</section>
<section id="do-dataset-versioning-well" class="level2">
<h2 class="anchored" data-anchor-id="do-dataset-versioning-well">Do dataset versioning well</h2>
<p>The <a href="https://www.w3.org/TR/vocab-dcat-3/">Data Catalog Vocabulary (DCAT) - Version 3</a> is currently going through its finalisation process, and one of the updates in the third version of the standard was the introduction of a <code>DatasetSeries</code> and <a href="https://www.w3.org/TR/vocab-dcat-3/#dataset-versions">some guidance on how to handle versioning of datasets</a>.</p>
<p>The way <a href="https://www.w3.org/TR/vocab-dcat-3/#ex-dataset-series-and-versions">DCAT describes things in its example</a>, it organises datasets into three layers.</p>
<ul>
<li>A <code>DatasetSeries</code> at the top, which groups together related datasets which are released at a regular cadence (such as the Gross Domestic Product).</li>
<li>A set of <code>Dataset</code>s which form part of the series. We referred to these as <em>editions</em> of a dataset series.</li>
<li>A set of <code>Dataset</code>s which are the various <em>versions</em> of a particular <em>edition</em>.</li>
</ul>
<p>As a diagram I imagine it like this:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TD
    A[DatasetSeries: GDP] --&gt; B[Edition: GDP July]
    B --&gt; G[Version: GDP July v1]
    A --&gt; C[Edition: GDP August]
    C --&gt; H[Version: GDP August v1]
    A --&gt; D[Edition: GDP September]
    D --&gt; E[Version: GDP September v1]
    D --&gt; F[Version: GDP September v2]
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>This allows us the ability to differentiate between releases of new data which are on a scheduled and expected basis (e.g.&nbsp;when we update each month with new data), vs.&nbsp;when we need to make a correction to a dataset due to some unexpected error or revision.</p>
<p>In terms of the identifiers for all of these resources, I imagined them looking like:</p>
<ul>
<li><code>https://data.gov.uk/datasets/gross-domestic-product</code>
<ul>
<li><code>https://data.gov.uk/datasets/gross-domestic-product/editions/2023-09</code>
<ul>
<li><code>https://data.gov.uk/datasets/gross-domestic-product/editions/2023-09/versions/1</code></li>
<li><code>https://data.gov.uk/datasets/gross-domestic-product/editions/2023-09/versions/2</code></li>
</ul></li>
</ul></li>
</ul>
<p>Additionally, I felt like an API could make a helpful assumption for users who didn‚Äôt specify a request for a specific edition or version. Should a user request <code>https://data.gov.uk/datasets/gross-domestic-product.csv</code>, it seemed like a sensible default would be to route the user through to the <em>latest</em> version of the <em>latest</em> edition ‚Äì in this instance <code>https://data.gov.uk/datasets/gross-domestic-product/editions/2023-09/versions/2.csv</code>.</p>
<section id="api-versioning" class="level3">
<h3 class="anchored" data-anchor-id="api-versioning">API versioning</h3>
<p>Another big debating point related to versioning was whether an API version identifier should feature in the identifier given to a dataset. My feeling is that the canonical identifier for a dataset should be a URL which does not have an API version identifier in it.</p>
<p>So ultimately, it can be fine to offer <code>https://data.gov.uk/v2/datasets/gross-domestic-product</code>, but only if the canonical URL, <code>https://data.gov.uk/datasets/gross-domestic-product</code>, works too.</p>
</section>
</section>
<section id="provide-metadata" class="level2">
<h2 class="anchored" data-anchor-id="provide-metadata">Provide metadata</h2>
<p>Many analysts use Google and other search engines to find information. By using good metadata and following standards, we make it easier for them to find and understand the data. The Data on the Web Best Practices gives a few different types of metadata which we should provide: descriptive metadata, structural metadata, licensing, provenance and data quality information being key examples.</p>
<p>There‚Äôs a few standards in this space which are of particular interest:</p>
<ul>
<li><a href="https://www.w3.org/TR/json-ld11/">JSON-LD</a></li>
<li><a href="https://www.w3.org/TR/vocab-dcat-3/">Data Catalog Vocabulary (DCAT) - Version 3</a></li>
<li><a href="https://schema.org">Schema.org</a></li>
<li><a href="https://w3c.github.io/csvw/primer/">CSV on the Web (CSVW)</a></li>
</ul>
<p><a href="https://developers.google.com/search/docs/appearance/structured-data/dataset">Google‚Äôs guidance</a> shows how to embed JSON-LD in a webpage‚Äôs HTML to add structured data about a dataset. This structured data can be used for dataset catalogs or other widgets. For example, <a href="https://www.google.com/search?q=gdp+of+uk">searching Google for the UK‚Äôs GDP</a> brings up an interactive chart at the top of the results, providing a quick and intuitive way to understand the data and get an answer.</p>
<p>Search engines typically recommend using Schema.org, but Google‚Äôs guidance suggests they also supports DCAT. We believed DCAT has a more developed vocabulary for describing dataset metadata, so I prefer using it over Schema.org in this instance. The DCAT standard <a href="https://www.w3.org/TR/vocab-dcat-3/#dcat-sdo">gives a mapping between DCAT and Schema.org</a>.</p>
<blockquote class="blockquote">
<p>We can understand structured data in web pages about datasets, using either <a href="https://schema.org/Dataset">schema.org Dataset markup</a>, or equivalent structures represented in <a href="https://www.w3.org/">W3C</a>‚Äôs Data Catalog Vocabulary (DCAT) format. We also are exploring experimental support for structured data based on <a href="https://www.w3.org/TR/tabular-data-primer/">W3C CSVW</a>, and expect to evolve and adapt our approach as best practices for dataset description emerge. For more information about our approach to dataset discovery, see <a href="https://blog.google/products/search/making-it-easier-discover-datasets/">Making it easier to discover datasets</a>.</p>
</blockquote>
<p>Google and the Data on the Web Best Practices also mention the CSV on the Web (CSVW) standard, which allows us to provide structural metadata about tabular datasets such as those found in CSV files. We were also interested in CSVW because it allows us to <a href="https://w3c.github.io/csvw/csv2rdf/">map tabular data into RDF</a>. We had some success creating RDF data cubes using the <a href="https://www.w3.org/TR/vocab-data-cube/">RDF data cube vocabulary</a>, and this approach has a lot of potential, but it requires significant effort and technical knowledge.</p>
<p>JSON-LD is a way to organise data that makes it easier for different systems to understand and use it together. We can create a JSON-LD <code>@context</code> to name the keys in our JSON however we like, for example, using ‚Äúsummary‚Äù instead of ‚Äúabstract‚Äù, while remaining interoperable with other metadata sources. The <code>@context</code> will map these keys back to the identifiers which are part of the metadata standards we‚Äôre using. This also allows us to provide interoperable responses in different languages, such as Welsh.</p>
<hr>
<p>Bringing these standards together, I imagined a metadata response for a dataset series looking something like this:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"@context"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/ns#"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"@id"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/datasets/gross-domestic-product"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"@type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dcat:DatasetSeries"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"identifier"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gdp"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"title"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gross Domestic Product (GDP)"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"summary"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gross Domestic Product (GDP) is the total monetary value of all goods and services produced within a country's borders in a specific time period."</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"description"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gross Domestic Product (GDP) is a comprehensive measure of a nation's overall economic activity. It represents the total monetary value of all goods and services produced within a country's borders in a specific time period, typically annually or quarterly."</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"issued"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-07-21T00:07:00+01:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"next_release"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-10-20T00:07:00+01:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"publisher"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"office-for-national-statistics"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"creator"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"office-for-national-statistics"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-13">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"contact_point"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-14">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gross Domestic Product Enquiries"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-15">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gdp@data.gov.uk"</span></span>
<span id="cb4-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb4-17">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"themes"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb4-18">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"economy"</span></span>
<span id="cb4-19">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-20">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"frequency"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"monthly"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-21">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"keywords"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb4-22">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gdp"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-23">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"inflation"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-24">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gross domestic product"</span></span>
<span id="cb4-25">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-26">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"licence"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-27">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"spatial_coverage"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"K02000001"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-28">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"temporal_coverage"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-29">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"start"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1989-01-01T00:00:00+00:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-30">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"end"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-09-01T00:00:00+01:00"</span></span>
<span id="cb4-31">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb4-32">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"temporal_resolution"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P1M"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-33">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"editions"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb4-34">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-35">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"@id"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/datasets/gross-domestic-product/2023-09"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-36">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"issued"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-09-21T00:07:00+01:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-37">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"modified"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-09-22T00:07:00+01:00"</span></span>
<span id="cb4-38">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-39">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-40">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"@id"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/datasets/gross-domestic-product/2023-08"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-41">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"issued"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-08-21T00:07:00+01:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-42">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"modified"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-08-21T00:07:00+01:00"</span></span>
<span id="cb4-43">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-44">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb4-45">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"@id"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/datasets/gross-domestic-product/2023-07"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-46">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"issued"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-07-21T00:07:00+01:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb4-47">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"modified"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-07-21T00:07:00+01:00"</span></span>
<span id="cb4-48">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-49">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb4-50"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Under <code>editions</code> we‚Äôve avoided a load of nested JSON and instead chosen to deliver a subset of important metadata items to the user. A user has enough information to make a decision about whether they should enquire further and make another request.</p>
<p>This was also a debating point, as I think in other API designs this sort of nesting seems to be frowned upon. In <a href="https://jsonapi.org/">json:api</a> or <a href="https://stateless.co/hal_specification.html">HAL</a>, additional resources are listed under a <code>_links</code> keyword with the idea that the user would make additional calls to the API to get further information. This approach makes sense for software engineers writing integrations, as it keeps responses small and standardised. However, I personally appreciate having a bit of additional nested metadata to help me decide whether to make an additional request.</p>
<hr>
<p>A request for metadata about a particular edition of a dataset would look very similar and likely reuse much of the metadata from the data series. Some core differences would include:</p>
<ul>
<li>We‚Äôd include some of the structural metadata.</li>
<li>We‚Äôd include information about <code>versions</code> and <code>distributions</code>, rather than <code>editions</code>.</li>
</ul>
<p>I imagined a response looking like this:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"@context"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/ns#"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"@id"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/datasets/gross-domestic-product/2023-09"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"@type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dcat:Dataset"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"identifier"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gdp-2023-09"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-6">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"title"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gross Domestic Product (GDP): September 2023"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-7">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"summary"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gross Domestic Product (GDP) is the total monetary value of all goods and services produced within a country's borders in a specific time period."</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-8">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"description"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gross Domestic Product (GDP) is a comprehensive measure of a nation's overall economic activity. It represents the total monetary value of all goods and services produced within a country's borders in a specific time period, typically annually or quarterly."</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"issued"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-09-21T00:07:00+01:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-10">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"modified"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-09-22T00:07:00+01:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-11">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"next_release"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-10-20T00:07:00+01:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-12">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"publisher"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"office-for-national-statistics"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-13">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"creator"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"office-for-national-statistics"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-14">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"contact_point"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-15">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"name"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gross Domestic Product Enquiries"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-16">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"email"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gdp@data.gov.uk"</span></span>
<span id="cb5-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb5-18">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"themes"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb5-19">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"economy"</span></span>
<span id="cb5-20">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-21">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"frequency"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"monthly"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-22">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"keywords"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb5-23">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gdp"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-24">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"inflation"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-25">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gross domestic product"</span></span>
<span id="cb5-26">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-27">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"licence"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-28">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"spatial_coverage"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"K02000001"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-29">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"temporal_coverage"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-30">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"start"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1989-01-01T00:00:00+00:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-31">        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"end"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-09-01T00:00:00+01:00"</span></span>
<span id="cb5-32">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">},</span></span>
<span id="cb5-33">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"temporal_resolution"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P1M"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-34">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"version"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-35">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"current_version"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/datasets/gross-domestic-product/2023-09/version/2"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-36">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"versions"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb5-37">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-38">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"@id"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/datasets/gross-domestic-product/2023-09/version/1"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-39">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"issued"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-09-21T00:07:00+01:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-40">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"modified"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-09-21T00:07:00+01:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-41">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"version_notes"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"This version was replaced following the correction of an error in the September 2023 data."</span></span>
<span id="cb5-42">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-43">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-44">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"@id"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/datasets/gross-domestic-product/2023-09/version/2"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-45">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"issued"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-09-22T00:07:00+01:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-46">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"modified"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-09-22T00:07:00+01:00"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-47">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-48">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-49">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"distributions"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb5-50">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-51">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"@id"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/datasets/gross-domestic-product/2023-09.csv"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-52">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"@type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dcat:Distribution"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"csvw:Table"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-53">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"url"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/datasets/gross-domestic-product/2023-09.csv"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-54">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"download_url"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/datasets/gross-domestic-product/2023-09.csv"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-55">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"csvw_metadata"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://data.gov.uk/datasets/gross-domestic-product/2023-09.csv-metadata.json"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-56">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"media_type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text/csv"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-57">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"table_schema"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-58">                <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"columns"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb5-59">                    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-60">                        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"title"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"geography"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-61">                        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"datatype"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-62">                        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"description"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The geographic area covered by the index."</span></span>
<span id="cb5-63">                    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-64">                    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-65">                        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"title"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time_period"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-66">                        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"datatype"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-67">                        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"description"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The time period covered by the index."</span></span>
<span id="cb5-68">                    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-69">                    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb5-70">                        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"title"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gross_domestic_product"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-71">                        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"datatype"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"decimal"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb5-72">                        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"description"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The value of the Gross Domestic Product."</span></span>
<span id="cb5-73">                    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-74">                <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb5-75">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-76">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb5-77">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb5-78"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>Here we‚Äôre embedding CSVW structural metadata within a wider JSON-LD document. The CSVW standard gives quite a specific specification of how a CSVW metadata file needs to look and be structured, and our experience was that it was a bit constraining. But if we store our metadata in a triple store, we should be able to construct a file which matches that described by the spec, or to do things like dynamically translate between using DCAT and Schema.org.</p>
<p>When we were creating RDF data cubes, I felt it was most natural metadata about these to add these as an additional distribution, so a dataset edition could have both a CSV representation and an RDF data cube representation.</p>
</section>
<section id="be-a-good-web-citizen" class="level2">
<h2 class="anchored" data-anchor-id="be-a-good-web-citizen">Be a good web citizen</h2>
<p>I briefly mentioned content negotiation and <a href="https://ruben.verborgh.org/blog/2013/11/29/the-lie-of-the-api/">this blog post by Ruben Verborgh</a>. Given that we have assigned a unique identifier to a dataset, such as <code>https://data.gov.uk/datasets/gross-domestic-product</code>, it would be beneficial to use web standards to allow users to request different representations of that dataset ‚Äì whether they want an HTML webpage, a CSV, or a JSON format.</p>
<p>The idea is that when you request <code>https://data.gov.uk/datasets/gross-domestic-product</code> from a web browser, the browser asks for an HTML page that is suitable for human consumption. But from our statistical tools, users could request a representation like CSV. Both tools use the same unique identifier, but ask for different representations.</p>
<p>By doing this, we ensure the dataset has a single identifier; a single URL that is indexed by Google, can be cited in academic papers and used in code without awkward URL manipulations.</p>
<p>Implementing content negotiation does require extra effort. I noticed <a href="https://ukparliament.github.io/ontologies/meta/weeknotes/2024/20/#content-negotiation-and-caching-catastrophes">a recent weeknote from parliament.gov.uk</a> where they faced issues with incorrect resource caching, but it‚Äôs great to see their attempts to provide this functionality and weighing up their options.</p>
<p>But for what it‚Äôs worth, I also think appending the filetype to the URL is reasonable. Requesting <code>https://data.gov.uk/datasets/gross-domestic-product.csv</code> and receiving a CSV would likely be seen as helpful. If I wanted the dataset‚Äôs data and metadata as a JSON, I could ask for <code>https://data.gov.uk/datasets/gross-domestic-product.json</code> instead.</p>
<p>This approach introduces different identifiers with distinct meanings:</p>
<ul>
<li><code>https://data.gov.uk/datasets/gross-domestic-product</code> represents a dataset, which is an abstract resource with no specific serialisation or representation.</li>
<li><code>https://data.gov.uk/datasets/gross-domestic-product.csv</code> represents the CSV distribution of that dataset.</li>
<li><code>https://data.gov.uk/datasets/gross-domestic-product.json</code> represents the JSON distribution of that dataset.</li>
</ul>
</section>
<section id="final-words" class="level2">
<h2 class="anchored" data-anchor-id="final-words">Final words</h2>
<p>With so many new services looking to solve similar problems, I hope these thoughts are helpful to others and show what inspired me as I was thinking how to provide a good dataset API to users.</p>
<p>If nothing else, I‚Äôd highlight that the <a href="https://w3c.github.io/dwbp/bp.html">Data on the Web Best Practices</a> is an incredible resource for those of us trying to make data more easily available to consumers.</p>


</section>

 ]]></description>
  <guid>https://rossbowen.github.io/blog/my-ideal-data-api/</guid>
  <pubDate>Sat, 29 Jun 2024 23:00:00 GMT</pubDate>
</item>
<item>
  <title>Exploring expert systems</title>
  <link>https://rossbowen.github.io/blog/exploring-expert-systems/</link>
  <description><![CDATA[ 




<p>I‚Äôve been reading <a href="https://sqlpatterns.com/p/debugging-your-business-with-data">Data Patterns</a> recently and I caught a line about trying to build a causal model of a business in order to understand it better.</p>
<blockquote class="blockquote">
<p>What I‚Äôm drawn to in particular is how the metric tree concept is really a way of expressing a causal model of how a business works. As my friend Cedric Chin says, ‚ÄúThe purpose of becoming data driven is to build a causal model of the business in your head. The purpose of doing all this work is that you want to understand how your business actually works and grows, not rely on superstitious beliefs about how your business works and grows.‚Äù</p>
</blockquote>
<p>This idea got me thinking about causal inference and I recalled a toy expert system used to determine if a patient has dyspnoea (shortness of breath). I found <a href="https://www.eecis.udel.edu/~shatkay/Course/papers/Lauritzen1988.pdf">the original paper</a> and decided to replicate the results using Stan.</p>
<p>The idea behind the system is:</p>
<blockquote class="blockquote">
<p>Shortness-of-breath (dyspnoea) may be due to tuberculosis, lung cancer or bronchitis, or none of them, or more than one of them. A recent visit to Asia increases the chances of tuberculosis, while smoking is known to be a risk factor for both lung cancer and bronchitis. The results of a single chest X-ray do not discriminate between lung cancer and tuberculosis, as neither does the presence or absence of dyspnoea.</p>
</blockquote>
<p>This description leads to a causal Directed Acyclic Graph (DAG) that shows the dependencies among different traits.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart
    A[visit to Asia?] --&gt; T[tuberculosis?]
    S[smoking?] --&gt; L[lung cancer?]
    S --&gt; B[bronchitis?]
    T --&gt; E[either tuberculosis or lung cancer?]
    L --&gt; E
    E --&gt; X[positive X-ray?]
    E --&gt; D[dyspnoea?]
    B --&gt; D
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>These DAGs help us understand the dependencies between different traits and ask interesting questions about the system. The paper mentions several scenarios:</p>
<blockquote class="blockquote">
<p>A patient presents at a chest clinic with dyspnoea, and has recently visited Asia. Smoking history and chest X-ray are not yet available. The doctor would like to know the chance that each of the diseases is present, and if tuberculosis were ruled out by another test, how would that change the belief in lung cancer? Also, would knowing smoking history or getting an X-ray contribute most information about cancer, given that smoking may ‚Äòexplain away‚Äô the dyspnoea since bronchitis is considered a possibility? Finally, when all information is in, can we identify which was the most influential in forming our judgement?</p>
</blockquote>
<p>We aim to simulate data using the model and relationships described in the paper. From these samples, we can estimate the probabilities for each of the questions posed.</p>
<section id="model-specification" class="level2">
<h2 class="anchored" data-anchor-id="model-specification">Model specification</h2>
<p>The paper provides several conditional probabilities:</p>
<ol type="1">
<li>The probability of someone visiting Asia is 0.01, and the probability of someone smoking is 0.5.</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Basia%7D%20=%201)%20=%200.01%20"></p>
<p><img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Bsmoking%7D%20=%201)%20=%200.5%20"></p>
<ol start="2" type="1">
<li>If someone has visited Asia, the probability of tuberculosis is 0.05. If they have not visited Asia, the probability is 0.01.</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Btuberculosis%7D%20=%201%20%5Cmid%20%5Ctext%7Basia%7D%20=%201)%20=%200.05%20"> <img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Btuberculosis%7D%20=%201%20%5Cmid%20%5Ctext%7Basia%7D%20=%200)%20=%200.01%20"></p>
<ol start="3" type="1">
<li>If someone smokes, the probability of lung cancer is 0.1. If they do not smoke, the probability is 0.01.</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Blung%20cancer%7D%20=%201%20%5Cmid%20%5Ctext%7Bsmoking%7D%20=%201)%20=%200.1%20"> <img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Blung%20cancer%7D%20=%201%20%5Cmid%20%5Ctext%7Bsmoking%7D%20=%200)%20=%200.01%20"></p>
<ol start="4" type="1">
<li>If someone smokes, the probability of bronchitis is 0.6. If they do not smoke, the probability is 0.3.</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Bbronchitis%7D%20=%201%20%5Cmid%20%5Ctext%7Bsmoking%7D%20=%201)%20=%200.6%20"> <img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Bbronchitis%7D%20=%201%5Cmid%20%5Ctext%7Bsmoking%7D%20=%200)%20=%200.3%20"></p>
<ol start="5" type="1">
<li>Having either tuberculosis or lung cancer is represented by the event ‚Äúeither‚Äù.</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%20%5C%7B%20%5Ctext%7Beither%7D%20=%201%20%5C%7D%20=%20%5C%7B%20%5Ctext%7Btuberculosis%7D%20=%201%20%5C%7D%20%5Cvee%20%5C%7B%20%5Ctext%7Blung%20cancer%7D%20=%201%20%5C%7D%20"></p>
<ol start="6" type="1">
<li>If someone has either tuberculosis or lung cancer, the probability of a positive x-ray is 0.98. If they do not have either, the probability is 0.05. This can be interpreted as the x-ray having 98% sensitivity and 95% specificity.</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Bx-ray%7D%20=%201%20%5Cmid%20%5Ctext%7Beither%7D%20=%201)%20=%200.98%20"> <img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Bx-ray%7D%20=%201%20%5Cmid%20%5Ctext%7Beither%7D%20=%200)%20=%200.05%20"></p>
<ol start="7" type="1">
<li>Finally, if someone has either tuberculosis or lung cancer and also has bronchitis, the probability of dyspnoea is 0.9. If they have either but not bronchitis, the probability is 0.7. If they do not have either but do have bronchitis, the probability is 0.8. If they have neither and do not have bronchitis, the probability is 0.1.</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Bdyspnoea%7D%20=%201%20%5Cmid%20%5Ctext%7Beither%7D%20=%201,%20%5Ctext%7Bbronchitis%7D%20=%201)%20=%200.9%20"> <img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Bdyspnoea%7D%20=%201%20%5Cmid%20%5Ctext%7Beither%7D%20=%201,%20%5Ctext%7Bbronchitis%7D%20=%200)%20=%200.7%20"> <img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Bdyspnoea%7D%20=%201%20%5Cmid%20%5Ctext%7Beither%7D%20=%200,%20%5Ctext%7Bbronchitis%7D%20=%201)%20=%200.8%20"> <img src="https://latex.codecogs.com/png.latex?%20P(%5Ctext%7Bdyspnoea%7D%20=%201%20%5Cmid%20%5Ctext%7Beither%7D%20=%200,%20%5Ctext%7Bbronchitis%7D%20=%200)%20=%200.1%20"></p>
</section>
<section id="simulating" class="level2">
<h2 class="anchored" data-anchor-id="simulating">Simulating</h2>
<p>I remembered <a href="https://chjackson.github.io/openbugsdoc/Examples/Asia.html">an old WinBUGS simulation which used this model</a>. The WinBUGS documentation was hard to find, but luckily <a href="https://github.com/chjackson"><code>@chjackson</code></a> has mirrored it on GitHub. Unfortunately, this example is missing from the <a href="https://github.com/stan-dev/example-models">example models</a> Stan repository.</p>
<p>The WinBUGS simulation chooses to specify each trait as a categorical variable with two categories, instead of modelling them as Bernoulli random variables - I‚Äôd guess to make it easier to specify the conditional probabilities.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">model</span>
<span id="cb1-2">{</span>
<span id="cb1-3">    smoking <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcat</span>(p.smoking[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb1-4">    tuberculosis <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcat</span>(p.tuberculosis[asia,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb1-5">    lung.cancer <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcat</span>(p.lung.cancer[smoking,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb1-6">    bronchitis <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcat</span>(p.bronchitis[smoking,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb1-7">    either <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(tuberculosis,lung.cancer)</span>
<span id="cb1-8">    xray <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcat</span>(p.xray[either,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb1-9">    dyspnoea <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dcat</span>(p.dyspnoea[either,bronchitis,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb1-10">}</span></code></pre></div>
<p>In this example, all parameters are known and included as data, so there are no unknown probabilistic parameters like in a typical Stan simulation. The Stan guidance has a section on <a href="https://mc-stan.org/docs/reference-manual/mcmc.html#sampling-without-parameters">sampling without parameters</a> which shows how we can use a <code>generated quantities</code> block to create data based on the model.</p>
<div class="cell" data-output.var="model">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">data</span> {</span>
<span id="cb2-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; p_asia;                  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 0.01</span></span>
<span id="cb2-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; p_smoking;               <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 0.5</span></span>
<span id="cb2-4"></span>
<span id="cb2-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The following are the conditional probabilities</span></span>
<span id="cb2-6">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; p_tuberculosis; <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 0.01, 0.05</span></span>
<span id="cb2-7">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; p_lung_cancer;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 0.01, 0.1</span></span>
<span id="cb2-8">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; p_bronchitis;   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 0.3, 0.6</span></span>
<span id="cb2-9">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; p_xray;         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 0.05, 0.98</span></span>
<span id="cb2-10">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; p_dyspnoea;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// 0.1, 0.8, 0.7, 0.9</span></span>
<span id="cb2-11">}</span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">generated quantities</span> {</span>
<span id="cb2-14">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; asia = bernoulli_rng(p_asia);</span>
<span id="cb2-15">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; smoking = bernoulli_rng(p_smoking);</span>
<span id="cb2-16">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; tuberculosis = bernoulli_rng(p_tuberculosis[asia + <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]);</span>
<span id="cb2-17">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; lung_cancer = bernoulli_rng(p_lung_cancer[smoking + <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]);</span>
<span id="cb2-18">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; bronchitis = bernoulli_rng(p_bronchitis[smoking + <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]);</span>
<span id="cb2-19">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; either = max(tuberculosis, lung_cancer);</span>
<span id="cb2-20">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; xray = bernoulli_rng(p_xray[either + <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]);</span>
<span id="cb2-21">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt; dyspnoea = bernoulli_rng(p_dyspnoea[either + <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, bronchitis + <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]);</span>
<span id="cb2-22">}</span></code></pre></div>
</div>
<p>We use indexing to retrieve the appropriate conditional probability at each step. For example, if <code>asia == 0</code> then <code>tuberculosis = bernoulli_rng(p_tuberculosis[1])</code>, but if <code>asia == 1</code> then <code>tuberculosis = bernoulli_rng(p_tuberculosis[2])</code>.</p>
<p>We run the model with <code>rstan</code> to generate our samples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>())</span>
<span id="cb3-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rstan_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto_write =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb3-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span>
<span id="cb3-7"></span>
<span id="cb3-8">data_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb3-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_asia         =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>,</span>
<span id="cb3-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_smoking      =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb3-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_tuberculosis =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>),</span>
<span id="cb3-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_lung_cancer  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>),</span>
<span id="cb3-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_bronchitis   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>),</span>
<span id="cb3-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_xray         =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.98</span>),</span>
<span id="cb3-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_dyspnoea     =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb3-16">)</span>
<span id="cb3-17"></span>
<span id="cb3-18">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sampling</span>(</span>
<span id="cb3-19">  model,</span>
<span id="cb3-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> data_list,</span>
<span id="cb3-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100000</span>,</span>
<span id="cb3-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb3-23">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">algorithm =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fixed_param"</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Needed for sampling without parameters</span></span>
<span id="cb3-24">)</span>
<span id="cb3-25"></span>
<span id="cb3-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(fit)</span></code></pre></div>
</div>
<p>The simulation ran successfully, and the <code>mean</code> column of the summary gives the marginal probabilities for each of the traits in the system. Let‚Äôs take a look at our samples:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rstan<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract</span>(fit)</span>
<span id="cb4-2">samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(params)</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(samples)</span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 200,000 √ó 9</span></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;     asia smoking tuberculosis lung_cancer bronchitis either  xray dyspnoea  lp__</span></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;    &lt;dbl&gt; &lt;dbl[1&gt;    &lt;dbl[1d]&gt;   &lt;dbl[1d]&gt;  &lt;dbl[1d]&gt; &lt;dbl[&gt; &lt;dbl&gt; &lt;dbl[1d&gt; &lt;dbl&gt;</span></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  1     0       0            0           0          0      0     0        0     0</span></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  2     0       1            0           0          1      0     0        1     0</span></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  3     0       1            0           0          0      0     0        0     0</span></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  4     0       0            0           0          0      0     0        0     0</span></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  5     0       1            0           0          1      0     0        0     0</span></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  6     0       1            0           0          1      0     0        1     0</span></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  7     0       1            0           0          1      0     0        0     0</span></span>
<span id="cb4-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  8     0       1            0           0          0      0     0        0     0</span></span>
<span id="cb4-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;  9     0       0            0           0          0      0     0        0     0</span></span>
<span id="cb4-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 10     0       0            0           0          0      0     0        0     0</span></span>
<span id="cb4-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # ‚Ñπ 199,990 more rows</span></span></code></pre></div>
</div>
</section>
<section id="answering-some-questions" class="level2">
<h2 class="anchored" data-anchor-id="answering-some-questions">Answering some questions</h2>
<p>So now we have some simulated data, we can estimate probabilities by looking at the proportion of samples which meet certain conditions. First, let‚Äôs do some sense checks to make sure our simulated data gives results we‚Äôd expect from the model specification.</p>
<p>The model specification says the probability of someone having visited Asia is 0.01, and the probability that someone smokes is 0.5. Our samples agree with this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb5-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asia_prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(asia),</span>
<span id="cb5-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smoking_prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(smoking)</span>
<span id="cb5-5">  )</span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 1 √ó 2</span></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   asia_prob smoking_prob</span></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;       &lt;dbl&gt;        &lt;dbl&gt;</span></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1   0.00952        0.504</span></span></code></pre></div>
</div>
<p>To check another, the model specification says that if someone smokes, the probability they have lung cancer is 0.1. If they do not smoke, the probability is 0.01. Our samples agree with this too, so it looks like our simulation has behaved as expected.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(smoking) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lung_cancer_prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(lung_cancer))</span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 2 √ó 2</span></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;     smoking lung_cancer_prob</span></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;dbl[1d]&gt;            &lt;dbl&gt;</span></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1         0          0.00957</span></span>
<span id="cb6-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2         1          0.101</span></span></code></pre></div>
</div>
<p>Now we can answer the questions from the paper:</p>
<blockquote class="blockquote">
<p>A patient presents at a chest clinic with dyspnoea, and has recently visited Asia. Smoking history and chest X-ray are not yet available. The doctor would like to know the chance that each of the diseases is present.</p>
</blockquote>
<p>Here we‚Äôll want to filter to samples where <code>asia == 1</code> and <code>dyspnoea == 1</code>, and to look at the occurrence of each of the other traits.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>lp__) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(asia <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dyspnoea <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make each instance of a disease appear on its own line</span></span>
<span id="cb7-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>asia,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>dyspnoea), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trait"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(trait) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probability =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(value))</span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 6 √ó 2</span></span>
<span id="cb7-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   trait        probability</span></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;              &lt;dbl&gt;</span></span>
<span id="cb7-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 bronchitis        0.803 </span></span>
<span id="cb7-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2 either            0.176 </span></span>
<span id="cb7-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 3 lung_cancer       0.0873</span></span>
<span id="cb7-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 4 smoking           0.643 </span></span>
<span id="cb7-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 5 tuberculosis      0.0931</span></span>
<span id="cb7-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 6 xray              0.217</span></span></code></pre></div>
</div>
<p>From this we can see it‚Äôs likely that the patient has bronchitis, and less likely that they have lung cancer or tuberculosis. It‚Äôs quite likely that the patient smokes, and less likely that a positive x-ray would be seen. The probabilities agree with what was <a href="https://chjackson.github.io/openbugsdoc/Examples/Asia.html">found in the WinBUGS simulation</a> (which are computed by taking one away from the <code>mean</code> in the reported table).</p>
<blockquote class="blockquote">
<p>‚Ä¶if tuberculosis were ruled out by another test, how would that change the belief in lung cancer?</p>
</blockquote>
<p>Here we filter for samples where <code>tuberculosis == 0</code> too.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>lp__) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(asia <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dyspnoea <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, tuberculosis <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>asia,<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>dyspnoea), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trait"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(trait) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probability =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(trait <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lung_cancer"</span>)</span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 1 √ó 2</span></span>
<span id="cb8-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   trait       probability</span></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;chr&gt;             &lt;dbl&gt;</span></span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 lung_cancer      0.0911</span></span></code></pre></div>
</div>
<p>The probability of lung cancer once we‚Äôve ruled out tuberculosis hasn‚Äôt changed by much.</p>
<blockquote class="blockquote">
<p>Also, would knowing smoking history or getting an X-ray contribute most information about cancer, given that smoking may ‚Äòexplain away‚Äô the dyspnoea since bronchitis is considered a possibility?</p>
</blockquote>
<p>Going back to the case where <code>asia == 1</code> and <code>dyspnoea == 1</code>, we can look at different cases for smoking history and x-ray results to see how that affects the probability of lung cancer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>lp__) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(asia <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dyspnoea <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(smoking) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lung_cancer_prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(lung_cancer))</span>
<span id="cb9-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 2 √ó 2</span></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;     smoking lung_cancer_prob</span></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;dbl[1d]&gt;            &lt;dbl&gt;</span></span>
<span id="cb9-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1         0           0.0130</span></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2         1           0.129</span></span>
<span id="cb9-11"></span>
<span id="cb9-12">samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>lp__) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(asia <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dyspnoea <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(xray) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb9-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lung_cancer_prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(lung_cancer))</span>
<span id="cb9-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 2 √ó 2</span></span>
<span id="cb9-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;        xray lung_cancer_prob</span></span>
<span id="cb9-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;dbl[1d]&gt;            &lt;dbl&gt;</span></span>
<span id="cb9-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1         0            0    </span></span>
<span id="cb9-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2         1            0.403</span></span></code></pre></div>
</div>
<p>Here we can see that the x-ray result gives a stronger signal for the presence (or absence) of lung cancer presence than smoking history.</p>
<blockquote class="blockquote">
<p>Finally, when all information is in, can we identify which was the most influential in forming our judgement?</p>
</blockquote>
<p>So given <code>asia == 1</code> and <code>dyspnoea == 1</code>, we can look at the samples for different known smoking histories and different xray results and see what they do to the probabilities for each of the diseases.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>lp__) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(asia <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dyspnoea <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(smoking, xray) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb10-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tuberculosis_prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(tuberculosis),</span>
<span id="cb10-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lung_cancer_prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(lung_cancer),</span>
<span id="cb10-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bronchitis_prob =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(bronchitis)</span>
<span id="cb10-9">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(xray)</span>
<span id="cb10-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; `summarise()` has grouped output by 'smoking'. You can override using the</span></span>
<span id="cb10-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; `.groups` argument.</span></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 4 √ó 5</span></span>
<span id="cb10-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # Groups:   smoking [2]</span></span>
<span id="cb10-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;     smoking      xray tuberculosis_prob lung_cancer_prob bronchitis_prob</span></span>
<span id="cb10-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;dbl[1d]&gt; &lt;dbl[1d]&gt;             &lt;dbl&gt;            &lt;dbl&gt;           &lt;dbl&gt;</span></span>
<span id="cb10-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1         0         0           0.00400           0                0.772</span></span>
<span id="cb10-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2         1         0           0.00236           0                0.915</span></span>
<span id="cb10-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 3         0         1           0.667             0.0702           0.404</span></span>
<span id="cb10-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 4         1         1           0.310             0.550            0.674</span></span></code></pre></div>
</div>
<p>From these results, we see that a positive x-ray increases the probability of lung cancer and tuberculosis, regardless of smoking status, while smoking increases bronchitis likelihood regardless of the x-ray result. The x-ray result appears to be the most influential additional information here, as it causes the largest changes to probabilities of the different diseases.</p>


</section>

 ]]></description>
  <guid>https://rossbowen.github.io/blog/exploring-expert-systems/</guid>
  <pubDate>Mon, 27 May 2024 23:00:00 GMT</pubDate>
</item>
<item>
  <title>How long will my machine last?</title>
  <link>https://rossbowen.github.io/blog/how-long-will-my-machine-last/</link>
  <description><![CDATA[ 




<p>When <a href="../../blog/confidence-intervals-in-the-wild">writing about confidence intervals</a> I came across <a href="https://bayes.wustl.edu/etj/articles/confidence.pdf">this 1974 paper</a> by E. T. Jaynes which had a nice problem about estimating the minimum lifetime of some machinery.</p>
<blockquote class="blockquote">
<p>EXAMPLE 5. TRUNCATED EXPONENTIAL DISTRIBUTION</p>
<p>The following problem has occurred in several industrial quality control situations. A device will operate without failure for a time <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> because of a protective chemical inhibitor injected into it; but at time <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> the supply of this chemical is exhausted, and failures then commence, following the exponential failure law.</p>
<p>It is not feasible to observe the depletion of this inhibitor directly; one can observe only the resulting failures. From data on actual failure times, estimate the time <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> of guaranteed safe operation by a confidence interval. Here we have a continuous sample space, and we are to estimate a location parameter <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, from the sample values <img src="https://latex.codecogs.com/png.latex?%7B%20x_1,%20x_2,%20%5Cldots%20x_n%20%7D">, distributed according to the law <img src="https://latex.codecogs.com/png.latex?%0Ap(dx%20%5Cmid%20%5Ctheta)%20=%0A%5Cbegin%7Bcases%7D%0A%20%20%5Cexp(%5Ctheta%20-%20x)%20dx%20&amp;%20x%20%3E%20%5Ctheta,%20%5C%5C%0A%20%200%20&amp;%20x%20%3C%20%5Ctheta%20.%0A%5Cend%7Bcases%7D%0A"></p>
</blockquote>
<p>I love this kind of ‚Äúreal life‚Äù problem. The paper makes the point that calculating a confidence interval is complicated and results in a completely unhelpful interval. It shows how a Bayesian approach gives much better results, but the paper jumps through to defining a posterior density without showing how it gets there. I wanted to work it though and thought it would be a chance to try out using <a href="https://mc-stan.org/">Stan</a>.</p>
<section id="some-maths" class="level2">
<h2 class="anchored" data-anchor-id="some-maths">Some maths</h2>
<p><a href="https://en.wikipedia.org/wiki/Poisson_point_process">Poisson processes</a> can be used to model the number of events which occur over time ‚Äì things like the number of phonecalls received in a call centre, the number of people who walk into a shop, or the number of cars which pass you by as you walk down the street.</p>
<p>If we denote the number of events to occur up to some time <img src="https://latex.codecogs.com/png.latex?t"> as <img src="https://latex.codecogs.com/png.latex?N(t)">, then the probability that <img src="https://latex.codecogs.com/png.latex?N(t)%20=%20n"> is given by the Poisson distribution:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20P(N(t)%20=%20n)%20=%20%5Cfrac%7B(%5Clambda%20t)%5En%7D%7Bn!%7D%20e%5E%7B-%5Clambda%20t%7D%20"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Clambda"> is the rate of events per unit time.</p>
<p>In our example an event is the failure of a machine. We‚Äôre interested in the time of each failure which we label as <img src="https://latex.codecogs.com/png.latex?T_1,%20T_2,%20%5Cldots,%20T_N">. Each of these times is independent of the others.</p>
<p>We can notice that the event <img src="https://latex.codecogs.com/png.latex?T_1%20%3E%20t"> is equivalent to saying that no events occurred by time <img src="https://latex.codecogs.com/png.latex?t">, which is the same as saying <img src="https://latex.codecogs.com/png.latex?N(t)%20=%200">. So we can write</p>
<p><img src="https://latex.codecogs.com/png.latex?%20P(T_1%20%3E%20t)%20=%20P(N(t)%20=%200)%20=%20e%5E%7B-%5Clambda%20t%7D.%20"></p>
<p>Probabilities must sum to one, so we can also note</p>
<p><img src="https://latex.codecogs.com/png.latex?%20P(T_1%20%5Cleq%20t)%20=%201%20-%20P(T_1%20%3E%20t)%20=%201%20-%20e%5E%7B-%5Clambda%20t%7D.%20"></p>
<p>The result, <img src="https://latex.codecogs.com/png.latex?1%20-%20e%5E%7B-%5Clambda%20t%7D">, is the cumulative distribution function for an exponential distribution with rate <img src="https://latex.codecogs.com/png.latex?lambda">, with probability density function</p>
<p><img src="https://latex.codecogs.com/png.latex?%20p(t%20%5Cmid%20%5Clambda)%20=%20%5Clambda%20e%5E%7B-%5Clambda%20t%7D.%20"></p>
<p>This means that <img src="https://latex.codecogs.com/png.latex?T_1%20%5Csim%20%5Ctext%7BExponential%7D(%5Clambda)">. By using the <a href="https://en.wikipedia.org/wiki/Memorylessness">memorylessness</a> property of the exponential distribution we can say that all <img src="https://latex.codecogs.com/png.latex?T_1,%20T_2,%20T_3"> etc. are exponentially distributed.</p>
<hr>
<p>In our problem there‚Äôs an added constraint ‚Äì the machines will run for a time <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> before the chemical inhibitor is exhausted and failures begin. This means that the failure times have a lower bound ‚Äì they will be at least <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> ‚Äì which leads us to describe the failure times as following a shifted exponential distribution</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(t%20%5Cmid%20%5Clambda,%20%5Ctheta)%20=%0A%5Cbegin%7Bcases%7D%0A%20%20%20%20%5Clambda%20%5Cexp(-%5Clambda%20(t%20-%20%5Ctheta))%20&amp;%20x%20%5Cgeq%20%5Ctheta,%20%5C%5C%0A%20%20%20%200%20&amp;%20x%20%3C%20%5Ctheta.%0A%5Cend%7Bcases%7D%0A"></p>
<p>If we set <img src="https://latex.codecogs.com/png.latex?%5Clambda%20=%201"> and multiply out the negative sign, this would be equivalent to the distribution given in the Jaynes paper.</p>
<p>We can see the effect of the shifting by plotting the probability density function for different values of <img src="https://latex.codecogs.com/png.latex?%5Ctheta">:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" data-startfrom="71" data-source-offset="-1" style="background: #f1f3f5;"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 70;"><span id="cb1-71">x_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-72"></span>
<span id="cb1-73">viewof lambda <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Inputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> {</span>
<span id="cb1-74">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">label</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tex</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\t</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">ext{lambda: }</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\l</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">ambda`</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-75">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">step</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-76">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-77">})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-78">viewof theta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Inputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x_length]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> {</span>
<span id="cb1-79">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">label</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tex</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\t</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">ext{theta: }</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\t</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">heta`</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-80">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">step</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-81">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-82">})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-83">viewof t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Inputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x_length]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> {</span>
<span id="cb1-84">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">label</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tex</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\P</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r(X </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\l</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">eq t): t`</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-85">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">step</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-86">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">value</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-87">})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-88"></span>
<span id="cb1-89">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Array</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">from</span>({ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">length</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> x_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> }<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> (_<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">=&gt;</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-90">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>((x_i) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">=&gt;</span> lambda <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Math</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>lambda <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (x_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> theta)))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-91">coordinates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>((x_i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> i) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">=&gt;</span> {</span>
<span id="cb1-92">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> { <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> x_i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">y</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> (x_i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> theta) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> y[i] }<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-93">})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-94"></span>
<span id="cb1-95">filteredCoordinates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> coordinates<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>((coord) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">=&gt;</span> coord<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> t)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb1-96"></span>
<span id="cb1-97">Plot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>({</span>
<span id="cb1-98">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> { <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">domain</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> x_length] }<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-99">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">marks</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> [</span>
<span id="cb1-100">    Plot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lineY</span>(coordinates<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> { <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">y</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span> })<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-101">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Add the stuff for the cumulative probability</span></span>
<span id="cb1-102">    Plot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">areaY</span>(filteredCoordinates<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> {</span>
<span id="cb1-103">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-104">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">y</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-105">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">fill</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-106">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">fillOpacity</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-107">    })<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-108">    Plot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lineY</span>(filteredCoordinates<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> {</span>
<span id="cb1-109">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">x</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-110">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">y</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-111">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">stroke</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-112">      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">strokeWidth</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-113">    })<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-114">    Plot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ruleX</span>([[t]])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-115">  ]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb1-116">})<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-6" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-7" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-8" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-9" data-nodetype="expression">

</div>
</div>
</div>
</div>
</section>
<section id="modelling-as-a-bayesian-problem" class="level2">
<h2 class="anchored" data-anchor-id="modelling-as-a-bayesian-problem">Modelling as a Bayesian problem</h2>
<p>The Jaynes paper derives a 90% credible interval for <img src="https://latex.codecogs.com/png.latex?%5Ctheta">. A 90% credible interval is a range of values where there‚Äôs a 90% chance that the actual value is within that range (a property which is not shared by confidence intervals!)</p>
<p>Our goal is to get a formula for the probability density of <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> by using the observed failure times, so we can derive an interval for <img src="https://latex.codecogs.com/png.latex?%5Ctheta">.</p>
<p>The Jaynes paper derives the posterior probability density for <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> as</p>
<blockquote class="blockquote">
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(%5Ctheta%20%5Cmid%20x_1,%20x_2,%20%5Cldots%20x_N)%20=%20%5Cbegin%7Bcases%7D%0A%20%20N%5Cexp(N(%5Ctheta%20-%20%5Cmin(t))),%20&amp;%20%5Ctheta%20%3C%20%5Cmin(t),%20%5C%5C%0A%20%200,%20&amp;%20%5Ctheta%20%3E%20%5Cmin(t).%0A%5Cend%7Bcases%7D%0A"></p>
</blockquote>
<p>We can derive this using Bayes‚Äô theorem,</p>
<p><img src="https://latex.codecogs.com/png.latex?%20p(%5Ctheta%20%5Cmid%20t_1,%20t_2,%20%5Cldots%20t_N)%20=%20%5Cfrac%7Bp(t_1,%20t_2,%20%5Cldots%20t_N%20%5Cmid%20%5Ctheta)p(%5Ctheta)%7D%7Bp(t_1,%20t_2,%20%5Cldots%20t_N)%7D.%20"></p>
<p>We choose a flat prior for <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, such that <img src="https://latex.codecogs.com/png.latex?p(%5Ctheta)%20%5Cpropto%201"> and set <img src="https://latex.codecogs.com/png.latex?%5Clambda%20=%201"> throughout. Since <img src="https://latex.codecogs.com/png.latex?p(%5Ctheta)%20%5Cpropto%201"> and <img src="https://latex.codecogs.com/png.latex?p(t_1,%20t_2,%20%5Cldots%20t_N)"> doesn‚Äôt depend on <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, we drop them as constants, ending up with</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(%5Ctheta%20%5Cmid%20t_1,%20t_2,%20%5Cldots%20t_N)%20%5Cpropto%20p(t_1,%20t_2,%20%5Cldots%20t_N%20%5Cmid%20%5Ctheta).%0A"></p>
<p>Using the independence of each failure time, we continue to simplify the expression:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%20%20%20%20p(%5Ctheta%20%5Cmid%20t_1,%20t_2,%20%5Cldots%20t_N)%20&amp;%20%5Cpropto%20p(t_1,%20t_2,%20%5Cldots%20t_N%20%5Cmid%20%5Ctheta)%20%5C%5C%0A%20%20%20%20&amp;%5Cpropto%20%5Cprod_%7Bi=1%7D%5E%7BN%7D%20p(t_i%20%5Cmid%20%5Ctheta)%20%5C%5C%0A%20%20%20%20&amp;%5Cpropto%20%5Cprod_%7Bi=1%7D%5E%7BN%7D%20%5Cexp%7B(%5Ctheta%20-%20t_i)%7D%20%5Ccdot%20%5Cmathbb%7B1%7D%20%5C%7B%20t_i%20%5Cgeq%20%5Ctheta%20%5C%7D%0A%5Cend%7Balign%7D%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7B1%7D%20%5C%7B%20t_i%20%5Cgeq%20%5Ctheta%20%5C%7D"> is the indicator function which is one if <img src="https://latex.codecogs.com/png.latex?t_i%20%5Cgeq%20%5Ctheta"> and zero otherwise. Continuing, we note that the union of the events <img src="https://latex.codecogs.com/png.latex?%5C%7B%20t_i%20%5Cgeq%20%5Ctheta%20%5C%7D"> is the same as the event <img src="https://latex.codecogs.com/png.latex?%5Cmin(t)%20%5Cgeq%20%5Ctheta">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%20%20%20%20p(%5Ctheta%20%5Cmid%20t_1,%20t_2,%20%5Cldots%20t_N)%20&amp;%5Cpropto%0A%20%20%20%20%20%20%20%20%5Cprod_%7Bi=1%7D%5E%7BN%7D%20%5Cexp%7B(%5Ctheta%20-%20t_i)%7D%20%5Ccdot%20%5Cmathbb%7B1%7D%20%5C%7B%20t_i%20%5Cgeq%20%5Ctheta%20%5C%7D%20%5C%5C%0A%20%20%20%20&amp;%20%5Cpropto%20e%5E%7BN%20%5Ctheta%7D%20%5Ccdot%20%5Cmathbb%7B1%7D%20%5C%7B%20%5Cmin(t)%20%5Cgeq%20%5Ctheta%20%5C%7D.%0A%5Cend%7Balign%7D%0A"></p>
<p>To get a probability distribution for <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, we recall that probability distributions must integrate to one,</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7D%20p(%5Ctheta%20%5Cmid%20t_1,%20t_2,%20%5Cldots%20t_N)%20d%5Ctheta%20=%201.%20"></p>
<p>We look to integrate our formula for <img src="https://latex.codecogs.com/png.latex?p(%5Ctheta%20%5Cmid%20t_1,%20t_2,%20%5Cldots%20t_N)">. We can use the result to form a probability density which integrates to one,</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7D%20p(%5Ctheta%20%5Cmid%20t_1,%20t_2,%20%5Cldots%20t_N)%20d%5Ctheta%0A%20%20%20%20&amp;=%20%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7D%20e%5E%7BN%20%5Ctheta%7D%20%5Ccdot%20%5Cmathbb%7B1%7D%20%5C%7B%5Cmin(t)%20%5Cgeq%20%5Ctheta%20%5C%7D%20d%5Ctheta%20%5C%5C%0A%20%20%20%20&amp;=%20%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cmin(t)%7D%20e%5E%7BN%20%5Ctheta%7D%20d%5Ctheta%20%5C%5C%0A%20%20%20%20&amp;=%20%5Cfrac%7B%5Cexp%7B(N%5Cmin(t))%7D%7D%7BN%7D%20.%0A%5Cend%7Balign%7D%0A"></p>
<p>If we divide our formula <img src="https://latex.codecogs.com/png.latex?e%5E%7BN%20%5Ctheta%7D%20%5Ccdot%20%5Cmathbb%7B1%7D%20%5C%7B%5Cmin(t)%20%5Cgeq%20%5Ctheta%20%5C%7D"> by <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cexp%7B(N%5Cmin(t))%7D%7D%7BN%7D"> we get a probability distribution for <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> which integrates to one,</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap(%5Ctheta%20%5Cmid%20t_1,%20t_2,%20%5Cldots%20t_N)%20=%0A%5Cbegin%7Bcases%7D%0A%20%20%20%20N%5Cexp(N(%5Ctheta%20-%20%5Cmin(t)))%20&amp;%20%5Ctext%7Bif%20%7D%20%5Ctheta%20%5Cleq%20%5Cmin(t),%20%5C%5C%0A%20%20%20%200%20&amp;%20%5Ctext%7Botherwise%7D%0A%5Cend%7Bcases%7D%0A"></p>
<p>which is the posterior probability given in the paper.</p>
</section>
<section id="deriving-a-credible-interval" class="level2">
<h2 class="anchored" data-anchor-id="deriving-a-credible-interval">Deriving a credible interval</h2>
<p>The paper provides three observed values for failure times: <img src="https://latex.codecogs.com/png.latex?%7Bt_1,%20t_2,%20t_3%7D%20=%20%7B12,%2014,%2016%7D">. From this it derives a 90% credible interval for <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> of <img src="https://latex.codecogs.com/png.latex?11.23%20%3C%20%5Ctheta%20%3C%2012">; this is what we aim to reproduce.</p>
<p>The resulting formula we‚Äôre trying to solve is to find <img src="https://latex.codecogs.com/png.latex?L"> and <img src="https://latex.codecogs.com/png.latex?U"> such that</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cint_L%5EU%20p(%5Ctheta%20%5Cmid%20t_1,%20t_2,%20t_3)%20=%200.9.%20"></p>
<p>We know that <img src="https://latex.codecogs.com/png.latex?%5Ctheta%20%5Cleq%20%5Cmin(t)"> and want to find the <em>shortest</em> credible interval, which means targeting the interval over the area with the bulk of the probability density. Since most of the probability density is near <img src="https://latex.codecogs.com/png.latex?%5Cmin(t)">, we set <img src="https://latex.codecogs.com/png.latex?U%20=%20%5Cmin(t)%20=%2012">. Substituting in everything else, we can solve for <img src="https://latex.codecogs.com/png.latex?L">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cint_L%5E%7B12%7D%203%5Cexp(3(%5Ctheta%20-%2012))%20=%200.9.%20"></p>
<p>Let‚Äôs expand the integral:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%20%20%20%20%5Cint_L%5E%7B12%7D%203%5Cexp(3(%5Ctheta%20-%2012))%20&amp;=%20%5Cexp(3(%5Ctheta%20-%2012))%20%5Cbig%7C_L%5E%7B12%7D%20%5C%5C%0A%20%20%20%20&amp;=%20%5Cvphantom%7B%5Cbig%7C_L%5E%7B12%7D%7D%20%5Cexp(0)%20-%20%5Cexp(3(L%20-%2012))%20%5C%5C%0A%20%20%20%20&amp;=%20%5Cvphantom%7B%5Cbig%7C_L%5E%7B12%7D%7D%201%20-%20%5Cexp(3(L%20-%2012)).%0A%5Cend%7Balign%7D%0A"></p>
<p>Finally, we solve for <img src="https://latex.codecogs.com/png.latex?L">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign%7D%201%20-%20%5Cexp(3(L%20-%2012))%20&amp;=%200.9%20%5C%5C%20&amp;%5Cimplies%20L%20=%2011.2325,%20%5Cend%7Balign%7D%20"></p>
<p>and with that, the interval we‚Äôve computed is the same as Jaynes‚Äô:</p>
<p><img src="https://latex.codecogs.com/png.latex?%2011.23%20%3C%20%5Ctheta%20%3C%2012.%20"></p>
</section>
<section id="simulations-with-stan" class="level2">
<h2 class="anchored" data-anchor-id="simulations-with-stan">Simulations with Stan</h2>
<p>Sometimes, deriving a posterior probability density is hard, and it‚Äôs not always possible to do so analytically (i.e.&nbsp;to get a nice formula we can work with). In these cases, we can use a simulation approach to get a posterior probability density. Stan is a probabilistic programming language which allows us to do this by performing <a href="https://en.wikipedia.org/wiki/Markov_chain_Monte_Carlo">Markov chain Monte Carlo (MCMC)</a> sampling.</p>
<p>We write a Stan program to simulate the posterior probability density for <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> given the observed values for failure times. Stan will simulate many possible values for <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, and we can use these to approximate the posterior probability density.</p>
<div class="cell" data-output.var="model">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">data</span> {</span>
<span id="cb2-2">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; N;  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Number of observations, a non-negative integer.</span></span>
<span id="cb2-3">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; t[N];  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Array of N observations, which are real numbers.</span></span>
<span id="cb2-4">}</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">parameters</span> {</span>
<span id="cb2-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// The parameter theta, constrained to be between 0 and the minimum value</span></span>
<span id="cb2-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// of t.</span></span>
<span id="cb2-9">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">upper</span>=min(t)&gt; theta; </span>
<span id="cb2-10">}</span>
<span id="cb2-11"></span>
<span id="cb2-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">model</span> {</span>
<span id="cb2-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// We don't explicitly write a prior for theta. Stan will assume theta</span></span>
<span id="cb2-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// has a flat prior on (0, min(t)).</span></span>
<span id="cb2-15"></span>
<span id="cb2-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// We specify a prior for each observation. Stan has a helpful syntax</span></span>
<span id="cb2-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// for specifying truncated distributions.</span></span>
<span id="cb2-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> (n <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:N) {</span>
<span id="cb2-19">        t[n] ~ exponential(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">T</span>[theta, ];</span>
<span id="cb2-20">    }</span>
<span id="cb2-21">}</span></code></pre></div>
</div>
<p>We can break this syntax down by its blocks:</p>
<ul>
<li><p>The <code>data</code> block is used to declare the data that will be input to the model. In this case, there are two data inputs: <code>N</code>, an integer representing the number of observations, and <code>t</code>, an array of real numbers representing the observations themselves. We will provide these values to the program when we run it.</p></li>
<li><p>The <code>parameters</code> block is used to declare parameters used in the statistical model, which do not need to be provided by the user. In this case, there is one parameter, <code>theta</code>, which we are estimating, and we specify it is a real number constrained to be between 0 and the minimum value of <code>t</code>.</p></li>
<li><p>The <code>model</code> block is used to specify the statistical model ‚Äì this is typically done by specifying the probability distribution of the data and the relationships to the defined parameters. In this case we specify a prior density for each observation <code>t[n]</code>. We use the <code>exponential</code> distribution, and set <img src="https://latex.codecogs.com/png.latex?%5Clambda%20=%201">. We also specify that the <a href="https://mc-stan.org/docs/reference-manual/sampling-statements.html#truncated-distributions">distribution is truncated</a> at <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, using the <code>T[theta, ]</code> syntax, which is how we achieve specifying the shifted exponential distribution.</p></li>
</ul>
<p>We can run the model using the <code>rstan</code> package in R. We provide the data inputs <code>N</code> and <code>t</code> and run the model for 20,000 iterations, using 4 chains.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>())</span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rstan_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto_write =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb3-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span>
<span id="cb3-6"></span>
<span id="cb3-7">N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb3-8">t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb3-9"></span>
<span id="cb3-10">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sampling</span>(model, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N =</span> N, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t =</span> t), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(fit)</span></code></pre></div>
</div>
<p>The model gives a nice summary of the results, including the mean, standard deviation, and quantiles for each parameter. We can see here that the model has provided a central estimate of <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> to be 11.67.</p>
<p>We can use R to access the samples from the model and plot the posterior probability density for <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> using a histogram.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract</span>(fit)</span>
<span id="cb4-2">samples <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tibble<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(params)</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(samples[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"theta"</span>]])</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://rossbowen.github.io/blog/how-long-will-my-machine-last/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>We can use the samples generated from our Monte Carlo simulation to estimate the probability that <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> is between 11.23 and 12:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">samples <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-2">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(theta) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">11.23</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> theta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> theta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n))</span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; # A tibble: 2 √ó 3</span></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   `11.23 &lt; theta &amp; theta &lt; 12`     n  prop</span></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt;   &lt;lgl[1d]&gt;                    &lt;int&gt; &lt;dbl&gt;</span></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 1 FALSE                         4039 0.101</span></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#&gt; 2 TRUE                         35961 0.899</span></span></code></pre></div>
</div>
<p>The results tell us that 89.9% of the simulated samples of <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> are in this range, which shows that 11.12 and 12 is a 90% credible interval for <img src="https://latex.codecogs.com/png.latex?%5Ctheta">. We‚Äôve managed to reproduce the result from the Jaynes paper!</p>


</section>

 ]]></description>
  <guid>https://rossbowen.github.io/blog/how-long-will-my-machine-last/</guid>
  <pubDate>Tue, 31 Oct 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Confidence intervals in the wild</title>
  <link>https://rossbowen.github.io/blog/confidence-intervals-in-the-wild/</link>
  <description><![CDATA[ 




<p>Confidence intervals have always come up during interviews for analytical roles. I‚Äôm usually asked what a confidence interval is, and I‚Äôll respond along the lines of the <a href="https://www.ons.gov.uk/methodology/methodologytopicsandstatisticalconcepts/uncertaintyandhowwemeasureit#confidence-interval">definition given by the Office for National Statistics</a>.</p>
<blockquote class="blockquote">
<p><strong>Using a 95% confidence interval</strong></p>
<p>A 95% confidence level is frequently used. This means that if we drew 20 random samples and calculated a 95% confidence interval for each sample using the data in that sample, we would expect that, on average, 19 out of the 20 (95%) resulting confidence intervals would contain the true population value and 1 in 20 (5%) would not. If we increased the confidence level to 99%, wider intervals would be obtained.</p>
</blockquote>
<p>This definition aligns with that I was taught ‚Äì if we took many samples and created many 95% confidence intervals, we‚Äôd expect 95% of those intervals to contain the true value for the parameter of interest. For many X% confidence intervals, we‚Äôd expect X% of the intervals to contain the true value.</p>
<p>I‚Äôve then been asked how I would help a non-technical audience interpret a specific confidence interval. The thing is, I‚Äôve never felt that confidence intervals are a good thing to use with that kind of audience. Many <a href="https://statmodeling.stat.columbia.edu/2017/12/28/stupid-ass-statisticians-dont-know-goddam-confidence-interval/">statisticians misinterpret them</a>, so how we could expect a non-technical audience to use them correctly?</p>
<p>I‚Äôve gotten into some awkward debates over this ‚Äì so here‚Äôs me getting my thoughts together.</p>
<section id="what-does-a-confidence-interval-actually-tell-you" class="level2">
<h2 class="anchored" data-anchor-id="what-does-a-confidence-interval-actually-tell-you">What does a confidence interval <em>actually</em> tell you?</h2>
<p>I‚Äôd see a confidence interval in the wild and feel a bit unsure of how I could interpret it. If the definition of a confidence interval describes a behavior across <em>many</em> intervals, what does it mean when we‚Äôre presented with a <em>single</em> interval?</p>
<p>A quick google and we see some common interpretations of confidence intervals:</p>
<ul>
<li>There‚Äôs a 95% chance that the parameter of interest lies within a 95% confidence interval.</li>
<li>Confidence intervals are a range in which we think the true value is likely to lie.</li>
</ul>
<p>I couldn‚Äôt see how either of these followed from the definition we used earlier, about creating many intervals and on average X% of them containing the true value. I went searching and found many blog posts on the subject from <a href="https://statmodeling.stat.columbia.edu/">Andrew Gelman</a>, one of which introduced <a href="https://statmodeling.stat.columbia.edu/wp-content/uploads/2014/09/fundamentalError.pdf">this paper from Richard Morey et al.</a> which has shaped my thoughts over the years.</p>
<hr>
<p>Take this example from some of the <a href="https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/conditionsanddiseases/bulletins/coronaviruscovid19infectionsurveycharacteristicsofpeopletestingpositiveforcovid19uk/16november2022">ONS‚Äôs COVID-19 reporting</a>:</p>
<blockquote class="blockquote">
<p>The latest estimated rate of coronavirus (COVID-19) reinfections on 28 October 2022 was 42.8 per 100,000 participant days at risk (95% confidence interval: 42.0 to 43.6).</p>
</blockquote>
<p>Here we have a single 95% interval reported alongside an estimate of the COVID-19 reinfection rate. Maybe this is one of the lucky intervals which contains the true reinfection rate, but maybe it‚Äôs not. We don‚Äôt know.</p>
<p>The idea behind the 95% confidence interval is to perform some procedure which, on average, returns intervals <img src="https://latex.codecogs.com/png.latex?(L,%20U)"> which contain the true parameter 95% of the time.</p>
<p><img src="https://latex.codecogs.com/png.latex?P(L(X)%20%5Cleq%20%5Ctheta%20%5Cleq%20U(X))%20=%200.95"></p>
<p>We write <img src="https://latex.codecogs.com/png.latex?L(X)"> and <img src="https://latex.codecogs.com/png.latex?U(X)"> to emphasise these are random variables which in practice will often depend on the data. The problem occurs when we try to replace <img src="https://latex.codecogs.com/png.latex?(L(X),%20U(X))"> with an actual interval we‚Äôve obtained.</p>
<p>If <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> was the true COVID-19 reinfection rate, <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> is just some fixed number we don‚Äôt know the value of. We can‚Äôt say anything probabilistic about the value of <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> (unless we start using Bayesian techniques).</p>
<p>But, if we replace <img src="https://latex.codecogs.com/png.latex?L(X)"> and <img src="https://latex.codecogs.com/png.latex?U(X)"> above with the obtained interval, the probability changes.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%20%20P(42.0%20%5Cleq%20%5Ctheta%20%5Cleq%2043.6)%20=%20%5Cbegin%7Bcases%7D%0A%20%20%20%201,%20&amp;%20%5Ctext%7Bif%20%7D%2042.0%20%5Cleq%20%5Ctheta%20%5Cleq%2043.6,%20%5C%5C%0A%20%20%20%200,%20&amp;%20%5Ctext%7Botherwise%7D.%0A%20%20%5Cend%7Bcases%7D%0A"></p>
<p>Andrew Gelman provides an analogy in <a href="https://statmodeling.stat.columbia.edu/2016/11/23/abraham-lincoln-confidence-intervals/">a blog post</a> to explain why the probability changes once you substitute actual values into the interval. To provide a similar analogy ‚Äì let‚Äôs say 170cm is a fairly average male height ‚Äì we could imagine that half of men are taller and half are shorter than 170cm. Bob is 168cm tall.</p>
<p>It seems reasonable to say, if <img src="https://latex.codecogs.com/png.latex?X"> was the height of some arbitrary man, that the probability of that man being taller than 170cm is a half.</p>
<p><img src="https://latex.codecogs.com/png.latex?P(X%20%3E%20170%5Ctext%7Bcm%7D)%20=%200.5."></p>
<p>But we can‚Äôt just replace <img src="https://latex.codecogs.com/png.latex?X">, which represents the height of some arbitrary man. with Bob‚Äôs height and expect the probability to remain the same. If we condition the above probability to talk specifically about Bob, rather than some arbitrary man, then the probability becomes 0, as Bob is shorter than 170cm.</p>
<p><img src="https://latex.codecogs.com/png.latex?P(X%20%3E%20170%5Ctext%7Bcm%7D%20%5Cmid%20X%20=%20%5Ctext%7BBob's%20height%7D)%20=%20P(168%5Ctext%7Bcm%7D%20%3E%20170%5Ctext%7Bcm%7D)%20=%200."></p>
<p>Jerzy Neyman (<a href="https://royalsocietypublishing.org/doi/epdf/10.1098/rsta.1937.0005">who introduced confidence intervals in this 1937 paper</a>) was so clear about their interpretation:</p>
<blockquote class="blockquote">
<p>It will be noticed that in the above description the probability statements refer to the problems of estimation with which the statistician will be concerned in the future. In fact, I have repeatedly stated that the frequency of correct results will tend to <img src="https://latex.codecogs.com/png.latex?%5Calpha">. Consider now the case when a sample <img src="https://latex.codecogs.com/png.latex?E'">, is already drawn, and the calculations have given <img src="https://latex.codecogs.com/png.latex?%5Cunderset%7B%5Cbar%7B%7D%7D%7B%5Ctheta%7D(E')%20=%201"> and <img src="https://latex.codecogs.com/png.latex?%5Cbar%7B%5Ctheta%7D(E')%20=%202">. <strong>Can we say that in this particular case the probability of the true value falling between 1 and 2 is equal to</strong> <img src="https://latex.codecogs.com/png.latex?%5Calpha">?</p>
<p><strong>The answer is obviously in the negative.</strong> The parameter <img src="https://latex.codecogs.com/png.latex?%5Ctheta_1"> is an unknown constant, and no probability statement concerning its value may be made, that is except for hypothetical and trivial ones</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Bequation%7D%20%5Ctag%7B21%7D%0A%20%20P(1%20%5Cleq%20%5Ctheta_1%20%5Cleq%202)%20=%20%5Cbegin%7Bcases%7D%0A%20%20%20%201,%20&amp;%20%5Ctext%7Bif%20%7D%201%20%5Cleq%20%5Ctheta_1%20%5Cleq%202,%20%5C%5C%0A%20%20%20%200,%20&amp;%20%5Ctext%7Bif%20either%20%7D%20%5Ctheta_1%20%5Cleq%202%20%5Ctext%7B%20or%20%7D%202%20%5Cgeq%20%5Ctheta_1.%0A%20%20%5Cend%7Bcases%7D%0A%5Cend%7Bequation%7D%0A"></p>
</blockquote>
<hr>
<p>To sum up ‚Äì we can‚Äôt say that <em>all</em> confidence intervals give a range of likely values for some parameter, at least not from the definition of a confidence interval alone. <em>Some</em> confidence intervals may be sensible to interpret as a Bayesian credible intervals, at which point we could make statements about likely values.</p>
<p>Or as Morey et al.&nbsp;put it:</p>
<blockquote class="blockquote">
<p>In the case where data are normally distributed, for instance, there is a particular prior that will lead to a confidence interval that is numerically identical to Bayesian credible intervals computed using the Bayesian posterior (Jeffreys, 1961; Lindley, 1965). This might lead one to suspect that it does not matter whether one uses confidence procedures or Bayesian procedures. We showed, however, that confidence intervals and credible intervals can disagree markedly. The only way to know that a confidence interval is numerically identical to some credible interval is to prove it. The correspondence cannot ‚Äì and should not ‚Äì be assumed.</p>
</blockquote>
</section>
<section id="closing-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="closing-thoughts">Closing thoughts</h2>
<p>I think that confidence intervals have a use, particularly when the procedures to create them provide intervals which help describe the uncertainty in an estimate. But I‚Äôd be nervous to include them when writing for non-technical audiences, mainly due to the risk of misinterpretation:</p>
<ul>
<li>A specific 95% confidence interval doesn‚Äôt cover the true value with 95% probability, but many readers will see an interval and assume that.</li>
<li>A confidence interval doesn‚Äôt give a range of likely values for some parameter, unless it is appropriate to interpret it as a Bayesian credible interval ‚Äì which a non-technical audience wouldn‚Äôt be familiar with. A reader may assume all intervals provide likely values, regardless of the underlying statistical model being applied.</li>
<li>The Morey et al.&nbsp;paper also covers how smaller confidence intervals don‚Äôt necessarily mean more precise estimates, which is another common misinterpretation (with some more discussion <a href="https://stats.stackexchange.com/questions/204530/what-do-confidence-intervals-say-about-precision-if-anything">here</a>). It‚Äôs true for <em>some</em> intervals.</li>
<li>Also, readers may not appreciate the difference between precision and accuracy, and think an estimate is better and assign more trust to it just because it‚Äôs precise, even if it‚Äôs completely inaccurate.</li>
</ul>
<p>Other gotchas I think make confidence intervals difficult to interpret:</p>
<ul>
<li>What does it mean to be confident anyway? What is a confidence level? Do most people interpret being confident in a confidence interval as meaning the interval is likely to contain the true value?</li>
<li>There‚Äôs some real mental gymnastics to remember that a 99% confidence interval is wider than a 95% confidence interval. A 99% interval is wider, so there‚Äôs more uncertainty, but we‚Äôre now 99% confident instead of 95% confident. ü§∑ To me, being more confident would meaning being able to provide a narrower interval with less uncertainty.</li>
<li>When two confidence intervals do not overlap, it means that the difference between the two parameters is statistically significant. But when two confidence intervals do overlap, they may or may not be significantly different. Overlapping intervals are often interpreted as meaning that the difference is not statistically significant, but this is not always the case.</li>
</ul>
<p>If I were to include confidence intervals in my writing then I‚Äôd expect the audience to have some level of technical knowledge, and I think it‚Äôs important to include what procedure has been used to compute the interval. If we think it is reasonable to interpret the interval as a Bayesian credible interval, then we can tell the audience that‚Äôs what we‚Äôre doing, and also include information about the prior we‚Äôve used as part of our methodology.</p>
</section>
<section id="more-reading" class="level2">
<h2 class="anchored" data-anchor-id="more-reading">More reading</h2>
<p>Some posts from Andrew Gelman‚Äôs blog:</p>
<ul>
<li><a href="https://statmodeling.stat.columbia.edu/2014/03/15/problematic-interpretations-confidence-intervals/">Problematic interpretations of confidence intervals</a></li>
<li><a href="https://statmodeling.stat.columbia.edu/2016/11/23/abraham-lincoln-confidence-intervals/">Abraham Lincoln and confidence intervals</a></li>
<li><a href="https://statmodeling.stat.columbia.edu/2017/03/04/interpret-confidence-intervals/">How to interpret confidence intervals?</a></li>
<li><a href="https://statmodeling.stat.columbia.edu/2022/04/05/confidence-intervals-compatability-intervals-uncertainty-intervals/">Confidence intervals, compatability intervals, uncertainty intervals</a></li>
</ul>
<p>Two papers from Richard Morey et al.</p>
<ul>
<li><a href="https://www.ejwagenmakers.com/inpress/HoekstraEtAlPBR.pdf">Robust misinterpretation of confidence intervals</a></li>
<li><a href="https://statmodeling.stat.columbia.edu/wp-content/uploads/2014/09/fundamentalError.pdf">The fallacy of placing confidence in confidence intervals</a></li>
</ul>


</section>

 ]]></description>
  <guid>https://rossbowen.github.io/blog/confidence-intervals-in-the-wild/</guid>
  <pubDate>Tue, 05 Sep 2023 23:00:00 GMT</pubDate>
</item>
</channel>
</rss>
